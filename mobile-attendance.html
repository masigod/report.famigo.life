<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>CLT On-site Attendance Management V2</title>
    <script src="env-config.js?v=20250922"></script>
    <script src="config-loader.js?v=20250922"></script>
    <script src="config.js?v=20250922"></script>
    <script src="security-utils.js?v=20250922"></script>
    <script src="error-handler.js?v=20250922"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #667eea;
            --primary-dark: #5a67d8;
            --success: #48bb78;
            --danger: #f56565;
            --warning: #ed8936;
            --bg: #f7fafc;
            --card: #ffffff;
            --text: #2d3748;
            --text-light: #718096;
            --border: #e2e8f0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
        }

        .logout-btn {
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            color: white;
            font-size: 14px;
            cursor: pointer;
        }

        /* Stats Cards */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding: 15px;
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 4px;
        }

        /* Time Filter */
        .time-filter {
            padding: 0 15px 15px;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
        }

        .time-filter::-webkit-scrollbar {
            display: none;
        }

        .time-btn {
            display: inline-block;
            padding: 8px 16px;
            margin-right: 8px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 14px;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
        }

        .time-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Search Bar */
        .search-container {
            padding: 0 15px 15px;
        }

        .search-input {
            width: 100%;
            padding: 12px 40px 12px 16px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            background: white;
        }

        .search-icon {
            position: absolute;
            right: 30px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
        }

        /* Participant List */
        .participant-list {
            padding: 0 15px 80px;
        }

        .participant-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }

        .participant-card:active {
            transform: scale(0.98);
        }

        .participant-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .participant-name {
            font-size: 16px;
            font-weight: 600;
        }

        .participant-status {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-pending {
            background: #fef5e7;
            color: #f39c12;
        }

        .status-attended {
            background: #e8f8f5;
            color: #27ae60;
        }

        .status-noshow {
            background: #fee;
            color: #e74c3c;
        }

        .participant-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 10px;
        }

        .checkin-btn {
            width: 100%;
            padding: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .checkin-btn:active {
            background: var(--primary-dark);
        }

        .checkin-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }

        /* Bottom Tab Bar */
        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid var(--border);
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            padding: 8px 0 env(safe-area-inset-bottom);
            z-index: 100;
        }

        .tab-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            cursor: pointer;
            color: var(--text-light);
            transition: color 0.2s;
        }

        .tab-item.active {
            color: var(--primary);
        }

        .tab-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .tab-label {
            font-size: 11px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            animation: fadeIn 0.2s;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            width: 30px;
            height: 30px;
            border: none;
            background: var(--bg);
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            color: var(--text-light);
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .reward-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .reward-option {
            padding: 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .reward-option.selected {
            border-color: var(--primary);
            background: #f0f4ff;
        }

        .reward-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .camera-container {
            position: relative;
            margin-bottom: 15px;
        }

        .camera-preview {
            width: 100%;
            border-radius: 10px;
            border: 2px dashed var(--border);
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg);
            overflow: hidden;
        }

        .camera-preview img {
            width: 100%;
            height: auto;
        }

        .camera-btn {
            width: 100%;
            padding: 12px;
            border: none;
            background: var(--primary);
            color: white;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 10px;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 20px;
        }

        .submit-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 2000;
            animation: slideDown 0.3s;
            display: none;
        }

        .notification.show {
            display: block;
        }

        .notification.success {
            background: var(--success);
            color: white;
        }

        .notification.error {
            background: var(--danger);
            color: white;
        }

        @keyframes slideDown {
            from { transform: translate(-50%, -20px); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div>
                <h1>CLT On-site Attendance</h1>
                <div style="font-size: 12px; opacity: 0.9;" id="staffInfo">Loading...</div>
            </div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <!-- Debug Log Area -->
    <div id="debugLog" style="display: none; background: #000; padding: 15px; margin: 10px; border-radius: 8px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 11px; color: #0f0; white-space: pre-wrap; word-break: break-all; border: 2px solid #0f0;">
        <div style="font-weight: bold; margin-bottom: 10px; color: #0f0;">🔍 DEBUG LOG:</div>
        <div id="debugContent"></div>
    </div>

    <!-- Main Content -->
    <div id="mainView">
        <!-- Date Selector -->
        <div style="padding: 15px 20px; background: white; border-bottom: 1px solid #e0e0e0;">
            <label style="display: block; font-size: 14px; color: #666; margin-bottom: 5px;">Select Date</label>
            <div style="display: flex; gap: 10px;">
                <input type="date" id="dateFilter" style="flex: 1; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
                <button onclick="document.getElementById('dateFilter').value=''; filterAndDisplayParticipants();" style="padding: 10px 15px; background: #667eea; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">Show All</button>
            </div>
        </div>
        <!-- Stats -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-value" id="totalCount">0</div>
                <div class="stat-label">Total</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="attendedCount">0</div>
                <div class="stat-label">Attended</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="pendingCount">0</div>
                <div class="stat-label">Pending</div>
            </div>
        </div>

        <!-- Time Filter -->
        <div class="time-filter" id="timeFilter">
            <button class="time-btn active" data-time="all">All</button>
            <button class="time-btn" data-time="13:00">13:00</button>
            <button class="time-btn" data-time="13:30">13:30</button>
            <button class="time-btn" data-time="14:00">14:00</button>
            <button class="time-btn" data-time="14:30">14:30</button>
            <button class="time-btn" data-time="15:00">15:00</button>
            <button class="time-btn" data-time="15:30">15:30</button>
            <button class="time-btn" data-time="16:00">16:00</button>
            <button class="time-btn" data-time="16:30">16:30</button>
        </div>

        <!-- Search -->
        <div class="search-container" style="position: relative;">
            <input type="text" class="search-input" id="searchInput" placeholder="Search by name or ID number...">
            <span class="search-icon">🔍</span>
        </div>

        <!-- Participant List -->
        <div class="participant-list" id="participantList">
            <div class="loading">
                <div class="spinner"></div>
                <div>Loading data...</div>
            </div>
        </div>
    </div>

    <!-- No-show View -->
    <div id="noshowView" style="display: none;">
        <div class="participant-list" id="noshowList">
            <!-- No-show participants will be loaded here -->
        </div>
    </div>

    <!-- Stats View -->
    <div id="statsView" style="display: none; padding: 20px;">
        <h2 style="margin-bottom: 20px;">오늘의 통계</h2>
        <div class="stats-detail">
            <!-- Detailed statistics will be shown here -->
        </div>
    </div>

    <!-- Bottom Tab Bar -->
    <div class="tab-bar">
        <div class="tab-item active" onclick="switchTab('main')">
            <div class="tab-icon">✓</div>
            <div class="tab-label">Attendance</div>
        </div>
        <div class="tab-item" onclick="switchTab('noshow')">
            <div class="tab-icon">✗</div>
            <div class="tab-label">No-show</div>
        </div>
        <div class="tab-item" onclick="switchTab('stats')">
            <div class="tab-icon">📊</div>
            <div class="tab-label">Statistics</div>
        </div>
    </div>

    <!-- Check-in Modal -->
    <div class="modal" id="checkinModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Check-in</h3>
                <button class="modal-close" onclick="closeCheckinModal()">×</button>
            </div>
            <div class="modal-body">
                <div id="checkinInfo" style="margin-bottom: 20px; padding: 15px; background: var(--bg); border-radius: 10px;">
                    <!-- Participant info will be shown here -->
                </div>

                <div class="form-group">
                    <label class="form-label">On-site Number (A-ID)</label>
                    <input type="text" id="aidInput" placeholder="e.g., A101, B202" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 16px;">
                </div>

                <div class="form-group">
                    <label class="form-label">Reward Type</label>
                    <div class="reward-options">
                        <div class="reward-option" onclick="selectReward('mobile')" data-reward="mobile">
                            <div class="reward-icon">📱</div>
                            <div>Gift-Card</div>
                        </div>
                        <div class="reward-option" onclick="selectReward('cash')" data-reward="cash">
                            <div class="reward-icon">💵</div>
                            <div>Transfer</div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">ID Card Front Photo (Optional)</label>
                    <div class="camera-container">
                        <div class="camera-preview" id="idFrontPreview">
                            <span style="color: var(--text-light);">📷 No photo</span>
                        </div>
                        <input type="file" id="idCardFrontInput" accept="image/*" capture="camera" style="display: none;">
                        <button class="camera-btn" onclick="document.getElementById('idCardFrontInput').click()">
                            Take Front Photo (Optional)
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">ID Card Back Photo (Optional)</label>
                    <div class="camera-container">
                        <div class="camera-preview" id="idBackPreview">
                            <span style="color: var(--text-light);">📷 No photo</span>
                        </div>
                        <input type="file" id="idCardBackInput" accept="image/*" capture="camera" style="display: none;">
                        <button class="camera-btn" onclick="document.getElementById('idCardBackInput').click()">
                            Take Back Photo (Optional)
                        </button>
                    </div>
                </div>

                <div class="form-group" id="bankbookGroup" style="display: none;">
                    <label class="form-label">Bankbook Photo</label>
                    <div style="margin-bottom: 10px;">
                        <label style="display: flex; align-items: center; gap: 8px; font-size: 14px; color: var(--text-light);">
                            <input type="checkbox" id="bankbookLaterCheck" checked style="width: 18px; height: 18px;">
                            <span>Check Later</span>
                        </label>
                    </div>
                    <div class="camera-container" id="bankbookCameraContainer" style="display: none;">
                        <div class="camera-preview" id="bankbookPreview">
                            <span style="color: var(--text-light);">📷 No photo</span>
                        </div>
                        <input type="file" id="bankbookInput" accept="image/*" capture="camera" style="display: none;">
                        <button class="camera-btn" onclick="document.getElementById('bankbookInput').click()">
                            Take Bankbook Photo
                        </button>
                    </div>
                </div>

                <button class="submit-btn" id="submitBtn" onclick="submitCheckin()" disabled>
                    Complete Check-in
                </button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
        // Configuration
        const AIRTABLE_API_KEY = typeof AIRTABLE_CONFIG !== 'undefined' ? AIRTABLE_CONFIG.API_KEY : '';
        const AIRTABLE_BASE_ID = typeof AIRTABLE_CONFIG !== 'undefined' ? AIRTABLE_CONFIG.BASE_ID : 'appZcPs57spwdoKQH';
        const AIRTABLE_TABLE_ID = typeof AIRTABLE_CONFIG !== 'undefined' ? AIRTABLE_CONFIG.TABLE_ID : 'tblxMzwX1wWJKIOhY';
        const ATTENDANCE_TABLE_ID = typeof AIRTABLE_CONFIG !== 'undefined' ? AIRTABLE_CONFIG.ATTENDANCE_TABLE_ID : 'tblUnxGfJXHp2qSHp';

        // Debug: Log configuration on load
        console.log('Configuration loaded:', {
            BASE_ID: AIRTABLE_BASE_ID,
            TABLE_ID: AIRTABLE_TABLE_ID,
            ATTENDANCE_TABLE_ID: ATTENDANCE_TABLE_ID,
            HAS_API_KEY: !!AIRTABLE_API_KEY
        });

        // Global variables
        let allParticipantsData = [];  // Store all data
        let participantsData = [];     // Filtered data
        let currentParticipant = null;
        let selectedReward = '';
        let idCardImageFront = null;
        let idCardImageBack = null;
        let bankbookImage = null;
        let currentUser = null;
        let airtableRecords = {};
        let debugLog = [];
        let lastLoadTime = 0;

        // Debug logger function
        function addDebugLog(message, data = null) {
            const timestamp = new Date().toLocaleTimeString('ko-KR');
            const logEntry = `[${timestamp}] ${message}`;

            debugLog.push(logEntry);
            if (data) {
                debugLog.push(JSON.stringify(data, null, 2));
            }

            // Update debug display
            const debugContent = document.getElementById('debugContent');
            if (debugContent) {
                debugContent.innerHTML = debugLog.join('\n');
                debugContent.scrollTop = debugContent.scrollHeight;
            }

            // Also log to console
            console.log(logEntry, data || '');
        }

        // Check authentication
        function checkAuth() {
            const session = sessionStorage.getItem('clt_session');
            if (!session) {
                window.location.href = 'login.html';
                return null;
            }

            const sessionData = JSON.parse(session);
            if (sessionData.expires < Date.now()) {
                sessionStorage.removeItem('clt_session');
                window.location.href = 'login.html';
                return null;
            }

            return sessionData;
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', async () => {
            return ErrorHandler.handle(async () => {
                currentUser = checkAuth();
                if (!currentUser) return;

                // Display staff info (sanitized)
                document.getElementById('staffInfo').textContent = `Staff: ${SecurityUtils.sanitizeHTML(currentUser.fullName)}`;

                // Set today's date as default (Seoul timezone)
                const koreaTime = new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Seoul"}));
                const today = koreaTime.toISOString().split('T')[0];
                const dateFilter = document.getElementById('dateFilter');
                if (dateFilter) {
                    dateFilter.value = today;
                    // Set min and max attributes for better UX
                    const oneYearAgo = new Date();
                    oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
                    const oneYearLater = new Date();
                    oneYearLater.setFullYear(oneYearLater.getFullYear() + 1);

                    dateFilter.min = oneYearAgo.toISOString().split('T')[0];
                    dateFilter.max = oneYearLater.toISOString().split('T')[0];
                    addDebugLog('📅 오늘 날짜로 설정:', today);
                } else {
                    addDebugLog('⚠️ dateFilter 엘리먼트를 찾을 수 없음');
                }

                // Load all participants once
                await loadAllParticipants(true);

                // Filter and display based on selected date
                filterAndDisplayParticipants();

                // Load attendance data from AttendanceImages if table exists
                if (ATTENDANCE_TABLE_ID && ATTENDANCE_TABLE_ID !== '') {
                    await loadAttendanceData();
                } else {
                    addDebugLog('AttendanceImages 테이블 ID가 설정되지 않음 - 스킵');
                }

                // Setup event listeners
                setupEventListeners();

                // Add date change listener
                document.getElementById('dateFilter').addEventListener('change', () => {
                    filterAndDisplayParticipants();
                });
            }, {
                showNotification: true,
                logError: true
            });
        });

        // Load all participants data (cached)
        async function loadAllParticipants(forceReload = false) {
            return ErrorHandler.handle(async () => {
                // Check if we should reload (every 5 minutes or forced)
                const now = Date.now();
                if (!forceReload && allParticipantsData.length > 0 && (now - lastLoadTime) < 300000) {
                    addDebugLog('⏱ 캐시된 데이터 사용');
                    return allParticipantsData;
                }
                addDebugLog('=== 전체 데이터 로드 시작 ===');

                // Always load all data (except Cancelled and Duplicate)
                const filterFormula = `AND({status}!='Cancelled', {status}!='Duplicate')`;

                // Fetch all records with pagination
                let allRecords = [];
                let offset = null;

                do {
                    let url = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_ID}?filterByFormula=${encodeURIComponent(filterFormula)}`;

                    if (offset) {
                        url += '&offset=' + offset;
                    }

                    const response = await ErrorHandler.fetchWithErrorHandling(url, {
                        headers: {
                            'Authorization': `Bearer ${AIRTABLE_API_KEY}`
                        },
                        timeout: 30000
                    });


                    const data = await response.json();
                    allRecords = allRecords.concat(data.records);
                    offset = data.offset;
                } while (offset);

                addDebugLog(`총 ${allRecords.length}개 레코드 로드 완료`);

                allParticipantsData = allRecords.map((record, index) => {
                    // Store mapping
                    if (record.fields.ID) {
                        airtableRecords[record.fields.ID] = record.id;
                    }

                    // Log first 3 records to see field names
                    if (index < 3) {
                        addDebugLog(`레코드 ${index + 1}:`, {
                            ID: record.fields.ID,
                            name: record.fields.name,
                            setDate: record.fields.setDate,
                            setTime: record.fields.setTime,
                            status: record.fields.status
                        });
                    }

                    return {
                        ...record.fields,
                        recordId: record.id
                    };
                });

                // Show available dates
                const uniqueDates = [...new Set(allParticipantsData.map(p => p.setDate))].sort();
                addDebugLog('📅 데이터가 있는 날짜들:', uniqueDates);

                // Sort by time
                allParticipantsData.sort((a, b) => {
                    const aTime = a.setTime || '';
                    const bTime = b.setTime || '';
                    return aTime.localeCompare(bTime);
                });

                lastLoadTime = now;
                addDebugLog('=== 전체 데이터 로드 완료 ===');
                return allParticipantsData;
            }, {
                showNotification: true,
                logError: true,
                fallbackValue: []
            }).catch(error => {
                addDebugLog('❌ 에러 발생:', error.message);
                addDebugLog('에러 상세:', error.stack);
                ErrorHandler.logError(error, { context: 'loadAllParticipants' });
                return [];
            });
        }

        // Load attendance data from AttendanceImages table
        async function loadAttendanceData() {
            return ErrorHandler.handle(async () => {
                addDebugLog('=== AttendanceImages 출석 데이터 로드 ===');

                const response = await ErrorHandler.fetchWithErrorHandling(
                    `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${ATTENDANCE_TABLE_ID}`,
                    {
                        headers: {
                            'Authorization': `Bearer ${AIRTABLE_API_KEY}`
                        },
                        timeout: 30000
                    }
                );


                const data = await response.json();
                addDebugLog(`AttendanceImages 레코드 ${data.records.length}개 로드`);

                // Update participants with attendance data
                data.records.forEach(record => {
                    const fields = record.fields;
                    const participantID = fields.participantID;

                    if (participantID) {
                        // Find participant in allParticipantsData
                        const participant = allParticipantsData.find(p => p.ID === participantID);
                        if (participant) {
                            participant.attendanceStatus = fields.attendanceStatus || 'Attended';
                            participant.checkinTime = fields.checkinTime;
                            participant.rewardType = fields.rewardType;
                            participant.checkinStaff = fields.staffName;
                            participant.aID = fields['A-ID'] || '';  // Load A-ID field
                            participant.attendanceRecordId = record.id;  // Store Airtable record ID for updates
                            addDebugLog(`참가자 ${participantID} 출석 상태 업데이트: ${fields.attendanceStatus} (Record ID: ${record.id}, A-ID: ${fields['A-ID'] || 'none'})`);
                        }
                    }
                });

                // Refresh display
                filterAndDisplayParticipants();
            }, {
                showNotification: false,
                logError: true
            }).catch(error => {
                addDebugLog('AttendanceImages 로드 에러:', error.message);
            });
        }

        // Filter and display participants based on selected date
        function filterAndDisplayParticipants() {
            const selectedDate = document.getElementById('dateFilter').value;

            addDebugLog('=== 필터링 시작 ===');
            addDebugLog('선택된 날짜 (input):', selectedDate || '전체');

            if (selectedDate) {
                // 선택된 날짜를 다양한 형식으로 준비
                const [year, month, day] = selectedDate.split('-');
                const monthInt = parseInt(month);
                const dayInt = parseInt(day);

                // 가능한 날짜 형식들
                const format1 = `${monthInt}/${dayInt}`;           // 9/22
                const format2 = `${year}-${month}-${day}`;         // 2025-09-22
                const format3 = `${year}.${monthInt}.${dayInt}`;   // 2025.9.22
                const format4 = `${year}/${monthInt}/${dayInt}`;   // 2025/9/22

                addDebugLog('비교할 날짜 형식들:', {
                    format1_MD: format1,
                    format2_YYYYMMDD: format2,
                    format3_Dot: format3,
                    format4_Slash: format4
                });

                // 첫 몇 개 데이터의 setDate 형식 확인
                if (allParticipantsData.length > 0) {
                    addDebugLog('데이터 샘플 (첫 3개):',
                        allParticipantsData.slice(0, 3).map(p => ({
                            name: p.name,
                            setDate: p.setDate
                        }))
                    );
                }

                // Filter by selected date (compare multiple formats)
                participantsData = allParticipantsData.filter(p => {
                    if (!p.setDate) return false;

                    const pDateStr = String(p.setDate);

                    // 데이터의 날짜를 정규화
                    let normalizedPDate = '';

                    if (pDateStr.includes('-')) {
                        // YYYY-MM-DD 형식
                        const [py, pm, pd] = pDateStr.split('-');
                        normalizedPDate = `${parseInt(pm)}/${parseInt(pd)}`;
                    } else if (pDateStr.includes('.')) {
                        // YYYY.M.D 또는 M.D 형식
                        const parts = pDateStr.split('.');
                        if (parts.length === 3) {
                            normalizedPDate = `${parseInt(parts[1])}/${parseInt(parts[2])}`;
                        } else if (parts.length === 2) {
                            normalizedPDate = `${parseInt(parts[0])}/${parseInt(parts[1])}`;
                        }
                    } else if (pDateStr.includes('/')) {
                        // M/D 또는 YYYY/M/D 형식
                        const parts = pDateStr.split('/');
                        if (parts.length === 3) {
                            normalizedPDate = `${parseInt(parts[1])}/${parseInt(parts[2])}`;
                        } else if (parts.length === 2) {
                            normalizedPDate = `${parseInt(parts[0])}/${parseInt(parts[1])}`;
                        }
                    }

                    // 비교
                    const matches = normalizedPDate === format1 ||
                                  pDateStr === format2 ||
                                  pDateStr === format3 ||
                                  pDateStr === format4;

                    if (matches && participantsData.length < 5) {
                        addDebugLog(`매칭: ${p.name}, setDate: ${pDateStr} → normalized: ${normalizedPDate}`);
                    }

                    return matches;
                });

                addDebugLog(`필터 결과: ${participantsData.length}개 (전체 ${allParticipantsData.length}개 중)`);
            } else {
                // Show all
                participantsData = [...allParticipantsData];
                addDebugLog(`전체 표시: ${participantsData.length}개`);
            }

            displayParticipants();
            updateStats();
        }

        // Display participants
        function displayParticipants() {
            const timeFilter = document.querySelector('.time-btn.active').dataset.time;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const listContainer = document.getElementById('participantList');

            // If searching, use all data instead of filtered data
            let dataToFilter = searchTerm ? allParticipantsData : participantsData;

            let filtered = dataToFilter.filter(p => {
                if (timeFilter !== 'all' && p.setTime !== timeFilter) return false;
                if (searchTerm) {
                    const matchName = p.name && p.name.toLowerCase().includes(searchTerm);
                    const matchID = p.ID && p.ID.toString().includes(searchTerm);
                    const matchPID = p.ID && (`P-${p.ID}`).toLowerCase().includes(searchTerm.toLowerCase());
                    const matchAID = p.aID && p.aID.toLowerCase().includes(searchTerm);
                    if (!matchName && !matchID && !matchPID && !matchAID) return false;
                }
                return true;
            });

            // No need to filter by today since loadParticipants already filters by selected date

            // Display date info if date is selected (but not when searching)
            const selectedDate = document.getElementById('dateFilter').value;
            let dateHeader = '';
            if (selectedDate && !searchTerm) {
                const date = new Date(selectedDate);
                const monthNames = ["January", "February", "March", "April", "May", "June",
                    "July", "August", "September", "October", "November", "December"];
                const dateStr = `${monthNames[date.getMonth()]} ${date.getDate()}`;
                const filterDate = `${date.getMonth() + 1}/${date.getDate()}`;

                // Log filtering info
                console.log('Display filter - Selected date:', filterDate);
                console.log('Display filter - Filtered count:', filtered.length);
                console.log('Display filter - Total participants:', participantsData.length);

                dateHeader = `
                    <div style="padding: 10px 15px; background: var(--primary); color: white; margin: -20px -20px 15px; text-align: center; font-weight: bold; border-radius: 8px 8px 0 0;">
                        📅 ${dateStr} Reservations (${filtered.length} people)
                    </div>
                `;
            } else if (searchTerm) {
                dateHeader = `
                    <div style="padding: 10px 15px; background: #059669; color: white; margin: -20px -20px 15px; text-align: center; font-weight: bold; border-radius: 8px 8px 0 0;">
                        🔍 Search Results from All Data (${filtered.length} found)
                    </div>
                `;
            }

            if (filtered.length === 0) {
                if (selectedDate) {
                    const date = new Date(selectedDate);
                    const monthNames = ["January", "February", "March", "April", "May", "June",
                        "July", "August", "September", "October", "November", "December"];
                    const dateStr = `${monthNames[date.getMonth()]} ${date.getDate()}`;
                    listContainer.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <div style="font-size: 48px; margin-bottom: 10px;">📅</div>
                            <div>No participants reserved for ${dateStr}</div>
                            <div style="font-size: 12px; margin-top: 10px; color: #667eea;">💡 Click 'Show All' to check other dates</div>
                        </div>
                    `;
                } else {
                    listContainer.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <div style="font-size: 48px; margin-bottom: 10px;">🔍</div>
                            <div>No search results</div>
                        </div>
                    `;
                }
                return;
            }

            const html = dateHeader + filtered.map(p => `
                <div class="participant-card" onclick="openCheckinModal(${p.ID})">
                    <div class="participant-header">
                        <div>
                            <div class="participant-name">${p.name || 'No name'}</div>
                            ${p.status !== 'Confirmed' ? `
                                <span style="display: inline-block; padding: 2px 6px; background: #fef3c7; color: #92400e; font-size: 10px; border-radius: 4px; margin-left: 8px;">
                                    ${p.status || 'Unknown'}
                                </span>
                            ` : ''}
                        </div>
                        <div class="participant-status status-${getStatusClass(p.attendanceStatus)}">
                            ${getStatusText(p.attendanceStatus)}
                        </div>
                    </div>
                    <div class="participant-info">
                        <div>📅 ${p.setDate || ''} ${p.setTime || ''}</div>
                        <div>🎨 ${p.skinColor || ''}</div>
                        <div>🆔 P-${p.ID || 'No ID'}</div>
                        ${p.aID ? `<div style="font-weight: 600; color: var(--primary);">🏷️ ${p.aID}</div>` : '<div style="color: var(--text-light);">🏷️ No A-ID</div>'}
                        <div>📞 ${p.phone || 'No phone'}</div>
                    </div>
                    ${p.attendanceStatus !== 'Attended' ?
                        '<button class="checkin-btn">Check-in</button>' :
                        `<div style="text-align: center;">
                            <div style="color: var(--success); font-size: 14px; margin-bottom: 8px;">
                                ✓ ${p.checkinTime ? new Date(p.checkinTime).toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'}) : ''} Checked in
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="checkin-btn" onclick="editAttendance(${p.ID})" style="background: #718096; font-size: 12px; padding: 8px; width: 100%;">
                                    Edit
                                </button>
                                <!-- 이미지 보기 버튼 임시 숨김 (보안 문제) -->
                                <!--
                                <button class="checkin-btn" onclick="viewImages(${p.ID})" style="background: #4a5568; font-size: 12px; padding: 8px; flex: 1;">
                                    View Images
                                </button>
                                -->
                            </div>
                        </div>`
                    }
                </div>
            `).join('');

            listContainer.innerHTML = html;
        }

        // Get status class
        function getStatusClass(status) {
            if (status === 'Attended') return 'attended';
            if (status === 'No-show') return 'noshow';
            return 'pending';
        }

        // Get status text
        function getStatusText(status) {
            if (status === 'Attended') return 'Attended';
            if (status === 'No-show') return 'No-show';
            return 'Pending';
        }

        // Update statistics
        function updateStats() {
            // Only count Confirmed status participants for statistics
            const confirmedParticipants = participantsData.filter(p => p.status === 'Confirmed');
            const total = confirmedParticipants.length;
            const attended = confirmedParticipants.filter(p => p.attendanceStatus === 'Attended').length;
            const pending = confirmedParticipants.filter(p => !p.attendanceStatus || p.attendanceStatus === 'Pending').length;

            addDebugLog('통계 업데이트:', {
                total: total,
                attended: attended,
                pending: pending,
                filteredData: participantsData.map(p => ({ID: p.ID, name: p.name, status: p.attendanceStatus}))
            });

            document.getElementById('totalCount').textContent = total;
            document.getElementById('attendedCount').textContent = attended;
            document.getElementById('pendingCount').textContent = pending;
        }

        // Open check-in modal
        function openCheckinModal(participantId) {
            currentParticipant = participantsData.find(p => p.ID === participantId);
            if (!currentParticipant) return;

            // Skip if already attended
            if (currentParticipant.attendanceStatus === 'Attended') {
                showNotification('This participant has already been checked in', 'error');
                return;
            }

            // Display participant info
            document.getElementById('checkinInfo').innerHTML = `
                <div style="font-weight: 600; font-size: 18px; margin-bottom: 8px;">${currentParticipant.name}</div>
                <div style="color: var(--text-light); font-size: 14px;">
                    <div>🆔 P-${currentParticipant.ID || 'ID 없음'}</div>
                    <div>📅 ${currentParticipant.setDate || ''} ${currentParticipant.setTime || ''}</div>
                    <div>📞 ${currentParticipant.phone || '연락처 없음'}</div>
                </div>
            `;

            // Reset form
            selectedReward = '';
            idCardImageFront = null;
            idCardImageBack = null;
            bankbookImage = null;

            // Reset bankbook checkbox to default (checked)
            document.getElementById('bankbookLaterCheck').checked = true;
            document.getElementById('bankbookCameraContainer').style.display = 'none';
            document.getElementById('aidInput').value = '';  // Reset A-ID field
            document.querySelectorAll('.reward-option').forEach(el => el.classList.remove('selected'));
            document.getElementById('idFrontPreview').innerHTML = '<span style="color: var(--text-light);">📷 No photo</span>';
            document.getElementById('idBackPreview').innerHTML = '<span style="color: var(--text-light);">📷 No photo</span>';
            document.getElementById('bankbookPreview').innerHTML = '<span style="color: var(--text-light);">📷 사진 없음</span>';
            document.getElementById('bankbookGroup').style.display = 'none';
            document.getElementById('submitBtn').disabled = true;

            // Show modal
            document.getElementById('checkinModal').classList.add('active');
        }

        // Close check-in modal
        function closeCheckinModal() {
            document.getElementById('checkinModal').classList.remove('active');
            currentParticipant = null;
        }

        // Select reward type
        function selectReward(type) {
            selectedReward = type;
            document.querySelectorAll('.reward-option').forEach(el => {
                el.classList.remove('selected');
            });
            document.querySelector(`[data-reward="${type}"]`).classList.add('selected');

            // Show/hide bankbook section
            document.getElementById('bankbookGroup').style.display = type === 'cash' ? 'block' : 'none';

            checkFormComplete();
        }

        // Check if form is complete
        function checkFormComplete() {
            const hasReward = selectedReward !== '';

            // ID card photos are now optional
            const hasIdCardFront = true;  // Always true - not required
            const hasIdCardBack = true;   // Always true - not required

            // Check bankbook requirement
            let hasBankbook = true;
            if (selectedReward === 'cash') {
                const isCheckLater = document.getElementById('bankbookLaterCheck').checked;
                hasBankbook = isCheckLater || (bankbookImage !== null);
            }

            // Only reward selection is required
            document.getElementById('submitBtn').disabled = !hasReward;
        }

        // Image compression - 더 강한 압축 적용
        function compressImage(file, maxWidth = 400, quality = 0.3) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        if (width > maxWidth) {
                            height = (maxWidth / width) * height;
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob((blob) => {
                            resolve(blob);
                        }, 'image/jpeg', quality);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // Submit check-in
        async function submitCheckin() {
            console.log('=== submitCheckin 함수 시작 ===');
            console.log('Current participant:', currentParticipant);
            console.log('ATTENDANCE_TABLE_ID:', ATTENDANCE_TABLE_ID);
            console.log('This function should only POST to AttendanceImages table');

            if (!currentParticipant) {
                console.error('No participant selected');
                return;
            }

            document.getElementById('submitBtn').disabled = true;
            document.getElementById('submitBtn').textContent = '처리 중...';

            return ErrorHandler.handle(async () => {
                // Create record in AttendanceImages table using exact field names from CSV
                const now = new Date();

                // Format checkDate properly (convert 9/22 to 2025-09-22)
                let formattedCheckDate = currentParticipant.setDate;
                if (formattedCheckDate && !formattedCheckDate.includes('-')) {
                    // Convert M/D to YYYY-MM-DD
                    const [month, day] = formattedCheckDate.split('/');
                    const year = new Date().getFullYear();
                    formattedCheckDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                }

                // Map reward type to Airtable values
                let rewardTypeValue = 'None';
                if (selectedReward === 'mobile') {
                    rewardTypeValue = 'Gift-Card';
                } else if (selectedReward === 'cash') {
                    rewardTypeValue = 'Transfer';
                }

                // Format datetime for Airtable
                // Try different format: YYYY-MM-DDTHH:mm:ss without milliseconds
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');

                // Try different format for Airtable - remove milliseconds and Z
                // Format: YYYY-MM-DDTHH:mm:ss.000Z
                const isoString = now.toISOString();
                console.log('Original ISO string:', isoString);

                // Try without milliseconds: YYYY-MM-DDTHH:mm:ss
                const checkinTimeFormatted = isoString.substring(0, 19);
                console.log('Formatted checkinTime (no ms/tz):', checkinTimeFormatted);

                // Airtable Date field requires YYYY-MM-DD format (date only, no time)
                const todayDate = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;

                // Get A-ID value from input
                const aidValue = document.getElementById('aidInput').value.trim();

                // Prepare data matching exact Airtable schema
                // checkinTime is Date type in Airtable (date only, no time)
                const checkinDateOnly = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;

                // Get bankbook check status
                const bankbookCheck = selectedReward === 'cash' ?
                    document.getElementById('bankbookLaterCheck').checked : false;

                const attendanceData = {
                    participantID: parseInt(currentParticipant.ID) || 0,
                    participantName: currentParticipant.name || '',
                    checkinTime: checkinDateOnly,  // Date field - YYYY-MM-DD format
                    attendanceStatus: 'Attended',
                    rewardType: rewardTypeValue,
                    staffName: currentUser.fullName || '',
                    staffID: currentUser.username || '',
                    checkDate: formattedCheckDate || '',  // Date when appointment was scheduled
                    checkTime: currentParticipant.setTime || '',  // Time slot (Single line text)
                    'A-ID': aidValue || '',  // New field for on-site ID
                    bankbookCheck: bankbookCheck,  // New field for bankbook check later status
                    notes: `Check-in completed - ${now.toLocaleString('en-US')}${aidValue ? ` | A-ID: ${aidValue}` : ''}${bankbookCheck ? ' | Bankbook: Check Later' : ''}`
                };

                // Detailed logging for debugging
                console.log('=== ATTENDANCE DATA DEBUG ===');
                console.log('participantID:', attendanceData.participantID, typeof attendanceData.participantID);
                console.log('participantName:', attendanceData.participantName, typeof attendanceData.participantName);
                console.log('checkinTime:', attendanceData.checkinTime, typeof attendanceData.checkinTime);
                console.log('attendanceStatus:', attendanceData.attendanceStatus, typeof attendanceData.attendanceStatus);
                console.log('rewardType:', attendanceData.rewardType, typeof attendanceData.rewardType);
                console.log('staffName:', attendanceData.staffName, typeof attendanceData.staffName);
                console.log('staffID:', attendanceData.staffID, typeof attendanceData.staffID);
                console.log('checkDate:', attendanceData.checkDate, typeof attendanceData.checkDate);
                console.log('checkTime:', attendanceData.checkTime, typeof attendanceData.checkTime);
                console.log('notes:', attendanceData.notes, typeof attendanceData.notes);
                console.log('=== END DEBUG ===');

                // Handle image data
                if (idCardImageFront || idCardImageBack || bankbookImage) {
                    let imageNote = '이미지 첨부: ';

                    // Convert images to base64 for temporary storage in notes
                    const imageDataPromises = [];

                    if (idCardImageFront) {
                        imageNote += '신분증 앞면 ';
                        imageDataPromises.push(
                            new Promise((resolve) => {
                                const reader = new FileReader();
                                reader.onloadend = () => {
                                    // Store base64 data in notes temporarily
                                    // Note: This is a temporary solution - consider external storage for production
                                    resolve(`[신분증 앞면 이미지 크기: ${(reader.result.length / 1024).toFixed(2)}KB]`);
                                };
                                reader.readAsDataURL(idCardImageFront);
                            })
                        );
                    }

                    if (idCardImageBack) {
                        imageNote += '신분증 뒷면 ';
                        imageDataPromises.push(
                            new Promise((resolve) => {
                                const reader = new FileReader();
                                reader.onloadend = () => {
                                    // Store base64 data in notes temporarily
                                    // Note: This is a temporary solution - consider external storage for production
                                    resolve(`[신분증 뒷면 이미지 크기: ${(reader.result.length / 1024).toFixed(2)}KB]`);
                                };
                                reader.readAsDataURL(idCardImageBack);
                            })
                        );
                    }

                    if (bankbookImage) {
                        imageNote += '통장사본';
                        imageDataPromises.push(
                            new Promise((resolve) => {
                                const reader = new FileReader();
                                reader.onloadend = () => {
                                    resolve(`[통장사본 이미지 크기: ${(reader.result.length / 1024).toFixed(2)}KB]`);
                                };
                                reader.readAsDataURL(bankbookImage);
                            })
                        );
                    }

                    const imageSizes = await Promise.all(imageDataPromises);
                    attendanceData.notes += `\n${imageNote}\n${imageSizes.join('\n')}`;

                    // Store images in localStorage temporarily (for demo/testing)
                    // In production, use proper image hosting service
                    try {
                        const imageKey = `images_${currentParticipant.ID}_${Date.now()}`;
                        console.log('Attempting to save images with key:', imageKey);
                        addDebugLog('이미지 저장 시도:', { key: imageKey, participantID: currentParticipant.ID });

                        // Convert images to base64 with size check
                        const frontBase64 = idCardImageFront ? await blobToBase64(idCardImageFront) : null;
                        const backBase64 = idCardImageBack ? await blobToBase64(idCardImageBack) : null;
                        const bankbookBase64 = bankbookImage ? await blobToBase64(bankbookImage) : null;

                        // Check sizes
                        const totalSize = (frontBase64?.length || 0) + (backBase64?.length || 0) + (bankbookBase64?.length || 0);
                        console.log('Total image data size:', (totalSize / 1024 / 1024).toFixed(2), 'MB');
                        addDebugLog('이미지 데이터 크기:', {
                            totalMB: (totalSize / 1024 / 1024).toFixed(2),
                            frontKB: frontBase64 ? (frontBase64.length / 1024).toFixed(2) : 0,
                            backKB: backBase64 ? (backBase64.length / 1024).toFixed(2) : 0,
                            bankbookKB: bankbookBase64 ? (bankbookBase64.length / 1024).toFixed(2) : 0
                        });

                        const imageData = {
                            participantID: currentParticipant.ID,
                            timestamp: new Date().toISOString(),
                            idCardFront: frontBase64,
                            idCardBack: backBase64,
                            bankbook: bankbookBase64
                        };

                        // Try to save to localStorage
                        localStorage.setItem(imageKey, JSON.stringify(imageData));

                        // Verify save was successful
                        const savedData = localStorage.getItem(imageKey);
                        if (savedData) {
                            console.log('Images successfully saved to localStorage');
                            addDebugLog('이미지 저장 성공 확인됨:', imageKey);

                            // List all image keys for this participant
                            const allKeys = [];
                            for (let i = 0; i < localStorage.length; i++) {
                                const key = localStorage.key(i);
                                if (key && key.startsWith(`images_${currentParticipant.ID}_`)) {
                                    allKeys.push(key);
                                }
                            }
                            console.log('All image keys for participant:', allKeys);
                            addDebugLog('참가자의 모든 이미지 키:', allKeys);
                        } else {
                            console.error('Failed to verify image save');
                            addDebugLog('이미지 저장 확인 실패');
                        }

                        attendanceData.notes += `\n이미지 저장 키: ${imageKey}`;

                        // Add image URLs to attendanceData for Airtable
                        // Note: Airtable Attachment fields require public URLs
                        // For now, we'll store base64 as text (not ideal for production)
                        // In production, upload to cloud storage first and use URLs

                        // Skip storing base64 images to Airtable (fields don't exist)
                        // Only save image info in notes and localStorage

                        if (frontBase64 || backBase64 || bankbookBase64) {
                            attendanceData.notes += '\n이미지 저장됨 (로컬 저장소)';

                            const imageCount = [frontBase64, backBase64, bankbookBase64].filter(Boolean).length;
                            addDebugLog('이미지 로컬 저장 완료', {
                                method: 'localStorage only',
                                totalImages: imageCount,
                                note: 'Airtable 이미지 필드 없음 - 로컬에만 저장'
                            });

                            console.log(`${imageCount}개 이미지가 로컬에 저장됨 (Airtable 필드 없어서 업로드 스킵)`);
                        }
                    } catch (e) {
                        console.error('Image save error:', e);
                        addDebugLog('이미지 저장 실패:', e.message);

                        // Try to save without images if localStorage is full
                        if (e.name === 'QuotaExceededError') {
                            showNotification('저장 공간이 부족합니다. 이미지를 저장할 수 없습니다.', 'error');
                            addDebugLog('localStorage 용량 초과');
                        }
                    }
                }

                // Helper function to convert blob to base64
                async function blobToBase64(blob) {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result);
                        reader.readAsDataURL(blob);
                    });
                }

                // Helper function to upload image to Cloudinary (free tier available)
                async function uploadToCloudinary(base64Image, publicId) {
                    try {
                        // Cloudinary free unsigned upload
                        // You need to create a free account at cloudinary.com
                        // and set up an unsigned upload preset
                        const CLOUDINARY_URL = 'https://api.cloudinary.com/v1_1/demo/image/upload';
                        const UPLOAD_PRESET = 'docs_upload_example_us_preset'; // Demo preset

                        const formData = new FormData();
                        formData.append('file', base64Image);
                        formData.append('upload_preset', UPLOAD_PRESET);
                        formData.append('public_id', publicId);

                        const response = await fetch(CLOUDINARY_URL, {
                            method: 'POST',
                            body: formData
                        });

                        if (response.ok) {
                            const data = await response.json();
                            return data.secure_url;
                        }
                        return null;
                    } catch (error) {
                        console.error('Cloudinary upload failed:', error);
                        return null;
                    }
                }

                // Debug: Log attempt (DO NOT use recordId for anything)
                addDebugLog('체크인 시도 - AttendanceImages 테이블에만 저장:', {
                    participantID: parseInt(currentParticipant.ID) || 0,
                    participantName: currentParticipant.name,
                    table: 'AttendanceImages',
                    method: 'POST (CREATE)',
                    note: 'Participants 테이블은 업데이트하지 않음'
                });

                // Only save to AttendanceImages table, DO NOT update Participants table
                if (!ATTENDANCE_TABLE_ID || ATTENDANCE_TABLE_ID === '') {
                    throw new Error('AttendanceImages 테이블 ID가 설정되지 않았습니다.');
                }

                addDebugLog('AttendanceImages 테이블에 저장 시도:', {
                    table: ATTENDANCE_TABLE_ID,
                    data: attendanceData
                });

                // Log the exact data being sent
                console.log('Sending to Airtable - Full attendanceData:', attendanceData);
                console.log('checkinTime format:', checkinTimeFormatted);
                console.log('checkinTime type:', typeof checkinTimeFormatted);
                console.log('checkDate format:', formattedCheckDate);
                console.log('Testing different formats:');
                console.log('  - ISO with Z:', now.toISOString());
                console.log('  - ISO no ms:', now.toISOString().split('.')[0] + 'Z');
                console.log('  - ISO no Z:', now.toISOString().substring(0, 19));
                console.log('  - Local string:', now.toLocaleString('ko-KR'));

                // Check if record exists (UPDATE) or new (CREATE)
                let response;
                const isUpdate = currentParticipant.attendanceRecordId;

                if (isUpdate) {
                    // UPDATE existing record
                    const updateUrl = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${ATTENDANCE_TABLE_ID}/${currentParticipant.attendanceRecordId}`;

                    addDebugLog('기존 레코드 업데이트:', {
                        recordId: currentParticipant.attendanceRecordId,
                        method: 'PATCH',
                        data: attendanceData
                    });

                    response = await fetch(updateUrl, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            fields: attendanceData
                        })
                    });
                } else {
                    // CREATE new record
                    const createUrl = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${ATTENDANCE_TABLE_ID}`;

                    addDebugLog('새 레코드 생성:', {
                        method: 'POST',
                        data: attendanceData
                    });

                    response = await fetch(createUrl, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            records: [{
                                fields: attendanceData
                            }]
                        })
                    });

                }

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Airtable API Error:', errorData);
                    addDebugLog('API 오류 상세:', errorData);

                    // Log specific field error details
                    if (errorData.error && errorData.error.type === 'INVALID_VALUE_FOR_COLUMN') {
                        console.error('Field validation error - full data:', attendanceData);
                        console.error('Error details:', errorData);
                        addDebugLog('필드 검증 실패 - 전체 데이터:', attendanceData);
                        addDebugLog('에러 상세:', errorData);
                    }

                    if (errorData.error && errorData.error.message) {
                        throw new Error(`Airtable: ${errorData.error.type} - ${errorData.error.message}`);
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                }

                const result = await response.json();

                if (isUpdate) {
                    addDebugLog('AttendanceImages 레코드 업데이트 성공:', result);
                } else {
                    // Store the new record ID for future updates
                    currentParticipant.attendanceRecordId = result.records ? result.records[0].id : result.id;
                    addDebugLog('AttendanceImages 레코드 생성 성공:', result);
                    addDebugLog('새 레코드 ID 저장:', currentParticipant.attendanceRecordId);
                }

                // Update local participant data
                const updateData = {
                    attendanceStatus: 'Attended',
                    checkinTime: now.toISOString(),
                    rewardType: rewardTypeValue,
                    checkinStaff: currentUser.fullName,
                    aID: aidValue || ''
                };

                Object.assign(currentParticipant, updateData);

                // Also update in allParticipantsData
                const index = allParticipantsData.findIndex(p => p.ID === currentParticipant.ID);
                if (index !== -1) {
                    Object.assign(allParticipantsData[index], updateData);
                }

                ErrorHandler.showNotification('Check-in completed!', 'success');
                closeCheckinModal();
                filterAndDisplayParticipants();
                updateStats();
            }, {
                showNotification: true,
                logError: true
            }).catch(error => {
                addDebugLog('체크인 에러:', error.message);
            }).finally(() => {
                document.getElementById('submitBtn').disabled = false;
                document.getElementById('submitBtn').textContent = '체크인 완료';
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Date filter change event
            const dateFilter = document.getElementById('dateFilter');
            if (dateFilter) {
                dateFilter.addEventListener('change', () => {
                    filterAndDisplayParticipants();
                });

                // Ensure today's date is set if the field is empty when focused
                dateFilter.addEventListener('focus', () => {
                    if (!dateFilter.value) {
                        const koreaTime = new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Seoul"}));
                        const today = koreaTime.toISOString().split('T')[0];
                        dateFilter.value = today;
                        addDebugLog('📅 빈 날짜 필드에 오늘 날짜 설정:', today);
                    }
                });
            }

            // Time filter
            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    displayParticipants();
                });
            });

            // Search
            document.getElementById('searchInput').addEventListener('input', displayParticipants);

            // ID card front input
            const idFrontInput = document.getElementById('idCardFrontInput');
            if (!idFrontInput) {
                console.error('ID Card Front Input element not found!');
                addDebugLog('ERROR: ID Card Front Input element not found');
            } else {
                console.log('ID Card Front Input found, adding listener');
                addDebugLog('ID Card Front Input found successfully');
                idFrontInput.addEventListener('change', async (e) => {
                    console.log('ID Card Front file selected:', e.target.files[0]);
                    addDebugLog('ID Card Front file selected', {
                        fileName: e.target.files[0]?.name,
                        fileSize: e.target.files[0]?.size
                    });
                    const file = e.target.files[0];
                    if (file) {
                        try {
                            idCardImageFront = await compressImage(file);
                            const url = URL.createObjectURL(idCardImageFront);
                            document.getElementById('idFrontPreview').innerHTML = `<img src="${url}" alt="ID Card Front">`;
                            console.log('ID Card Front image processed successfully');
                            addDebugLog('ID Card Front image processed successfully');
                            checkFormComplete();
                        } catch (error) {
                            console.error('Error processing ID Card Front:', error);
                            addDebugLog('Error processing ID Card Front:', error.message);
                            showNotification('Failed to process image', 'error');
                        }
                    }
                });
            }

            // ID card back input
            const idBackInput = document.getElementById('idCardBackInput');
            if (!idBackInput) {
                console.error('ID Card Back Input element not found!');
            } else {
                console.log('ID Card Back Input found, adding listener');
                idBackInput.addEventListener('change', async (e) => {
                    console.log('ID Card Back file selected:', e.target.files[0]);
                    const file = e.target.files[0];
                    if (file) {
                        try {
                            idCardImageBack = await compressImage(file);
                            const url = URL.createObjectURL(idCardImageBack);
                            document.getElementById('idBackPreview').innerHTML = `<img src="${url}" alt="ID Card Back">`;
                            console.log('ID Card Back image processed successfully');
                            checkFormComplete();
                        } catch (error) {
                            console.error('Error processing ID Card Back:', error);
                            showNotification('Failed to process image', 'error');
                        }
                    }
                });
            }

            // Bankbook later checkbox
            document.getElementById('bankbookLaterCheck').addEventListener('change', (e) => {
                const isChecked = e.target.checked;
                document.getElementById('bankbookCameraContainer').style.display = isChecked ? 'none' : 'block';

                if (isChecked) {
                    // Clear bankbook image if "Check Later" is selected
                    bankbookImage = null;
                    document.getElementById('bankbookPreview').innerHTML = '<span style="color: var(--text-light);">📷 No photo</span>';
                }
                checkFormComplete();
            });

            // Bankbook input
            const bankbookInput = document.getElementById('bankbookInput');
            if (!bankbookInput) {
                console.error('Bankbook Input element not found!');
            } else {
                console.log('Bankbook Input found, adding listener');
                bankbookInput.addEventListener('change', async (e) => {
                    console.log('Bankbook file selected:', e.target.files[0]);
                    const file = e.target.files[0];
                    if (file) {
                        try {
                            bankbookImage = await compressImage(file);
                            const url = URL.createObjectURL(bankbookImage);
                            document.getElementById('bankbookPreview').innerHTML = `<img src="${url}" alt="Bankbook">`;
                            console.log('Bankbook image processed successfully');
                            checkFormComplete();
                        } catch (error) {
                            console.error('Error processing Bankbook:', error);
                            showNotification('Failed to process image', 'error');
                        }
                    }
                });
            }
        }

        // Switch tabs
        function switchTab(tab) {
            document.querySelectorAll('.tab-item').forEach(item => item.classList.remove('active'));
            event.currentTarget.classList.add('active');

            document.getElementById('mainView').style.display = tab === 'main' ? 'block' : 'none';
            document.getElementById('noshowView').style.display = tab === 'noshow' ? 'block' : 'none';
            document.getElementById('statsView').style.display = tab === 'stats' ? 'block' : 'none';

            if (tab === 'noshow') {
                displayNoShows();
            } else if (tab === 'stats') {
                displayStats();
            }
        }

        // Display no-shows
        function displayNoShows() {
            const koreaTime = new Date(new Date().toLocaleString("en-US", {timeZone: "Asia/Seoul"}));
            const todayStr = `${koreaTime.getMonth() + 1}/${koreaTime.getDate()}`;

            const noShows = participantsData.filter(p =>
                p.setDate === todayStr && p.attendanceStatus === 'No-show'
            );

            const html = noShows.map(p => `
                <div class="participant-card">
                    <div class="participant-header">
                        <div class="participant-name">${p.name || 'No name'}</div>
                        <div class="participant-status status-noshow">노쇼</div>
                    </div>
                    <div class="participant-info">
                        <div>📅 ${p.setDate} ${p.setTime}</div>
                        <div>📞 ${p.phone || 'No phone'}</div>
                    </div>
                    <button class="checkin-btn" onclick="changeToAttended(${p.ID})" style="background: var(--success);">
                        Change to Attended
                    </button>
                </div>
            `).join('');

            document.getElementById('noshowList').innerHTML = html ||
                '<div class="loading">No no-show participants</div>';
        }

        // Display statistics
        function displayStats() {
            const selectedDate = document.getElementById('dateFilter').value;
            // Only show statistics for Confirmed status participants
            let displayParticipants = participantsData.filter(p => p.status === 'Confirmed');
            let dateLabel = 'All Period';

            if (selectedDate) {
                // Keep date filter but only for Confirmed participants
                const date = new Date(selectedDate);
                const monthNames = ["January", "February", "March", "April", "May", "June",
                    "July", "August", "September", "October", "November", "December"];
                dateLabel = `${monthNames[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`;
            }

            const attended = displayParticipants.filter(p => p.attendanceStatus === 'Attended');
            const pending = displayParticipants.filter(p => !p.attendanceStatus || p.attendanceStatus === 'Pending');
            const noshow = displayParticipants.filter(p => p.attendanceStatus === 'No-show');

            const mobileCount = attended.filter(p => p.rewardType === 'Gift-Card' || p.rewardType === 'MobileVoucher').length;
            const transferCount = attended.filter(p => p.rewardType === 'Transfer' || p.rewardType === 'Cash').length;

            // Group by time slots for detailed stats
            const timeSlots = {};
            displayParticipants.forEach(p => {
                const slot = p.setTime || 'Time TBD';
                if (!timeSlots[slot]) {
                    timeSlots[slot] = { total: 0, attended: 0, pending: 0, noshow: 0 };
                }
                timeSlots[slot].total++;
                if (p.attendanceStatus === 'Attended') timeSlots[slot].attended++;
                else if (p.attendanceStatus === 'No-show') timeSlots[slot].noshow++;
                else timeSlots[slot].pending++;
            });

            const html = `
                <div style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 15px;">
                    <h3 style="margin-bottom: 15px;">📊 ${dateLabel} Attendance Status</h3>
                    <div style="padding: 8px; background: #e0f2fe; border-radius: 6px; margin-bottom: 12px; font-size: 13px; color: #0369a1;">
                        ℹ️ Only participants with Confirmed status are counted
                    </div>
                    <div style="display: grid; gap: 10px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>Confirmed Participants</span>
                            <strong>${displayParticipants.length} people</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>✅ Attended</span>
                            <strong style="color: var(--success);">${attended.length} people</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>⏳ Pending</span>
                            <strong style="color: var(--warning);">${pending.length} people</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>❌ No-show</span>
                            <strong style="color: var(--danger);">${noshow.length} people</strong>
                        </div>
                    </div>
                    ${displayParticipants.length > 0 ? `
                        <div style="margin-top: 15px; padding: 10px; background: var(--bg); border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 14px;">Attendance Rate</span>
                                <strong style="font-size: 24px; color: var(--primary);">
                                    ${Math.round((attended.length / displayParticipants.length) * 100)}%
                                </strong>
                            </div>
                            <div style="margin-top: 10px; height: 10px; background: #e0e0e0; border-radius: 5px; overflow: hidden;">
                                <div style="height: 100%; background: var(--success); width: ${(attended.length / displayParticipants.length) * 100}%;"></div>
                            </div>
                        </div>
                    ` : ''}
                </div>

                <div style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 15px;">
                    <h3 style="margin-bottom: 15px;">💰 Reward Status</h3>
                    <div style="display: grid; gap: 10px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>🎁 Gift-Card</span>
                            <strong>${mobileCount} people</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>💵 Transfer</span>
                            <strong>${transferCount} people</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>➖ No Reward</span>
                            <strong>${attended.filter(p => !p.rewardType || p.rewardType === 'None').length} people</strong>
                        </div>
                    </div>
                </div>

                <div style="background: white; border-radius: 10px; padding: 20px;">
                    <h3 style="margin-bottom: 15px;">⏰ Time Slot Status</h3>
                    <div style="display: grid; gap: 10px;">
                        ${Object.entries(timeSlots)
                            .sort((a, b) => a[0].localeCompare(b[0]))
                            .map(([time, stats]) => `
                                <div style="border-left: 3px solid var(--primary); padding-left: 10px;">
                                    <div style="font-weight: 600; margin-bottom: 5px;">${time}</div>
                                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; font-size: 12px;">
                                        <span>Total: ${stats.total}</span>
                                        <span style="color: var(--success);">Attended: ${stats.attended}</span>
                                        <span style="color: var(--warning);">Pending: ${stats.pending}</span>
                                        <span style="color: var(--danger);">No-show: ${stats.noshow}</span>
                                    </div>
                                </div>
                            `).join('')}
                    </div>
                </div>
            `;

            document.getElementById('statsView').innerHTML = `
                <h2 style="margin-bottom: 20px;">Today's Statistics</h2>
                ${html}
            `;
        }

        // Edit attendance record
        window.editAttendance = async function(participantId) {
            console.log('editAttendance called for participant:', participantId);
            addDebugLog('editAttendance 호출됨:', { participantId });

            try {
                currentParticipant = participantsData.find(p => p.ID === participantId);
                if (!currentParticipant) {
                    console.error('Participant not found:', participantId);
                    addDebugLog('참가자를 찾을 수 없음:', { participantId });
                    showNotification('참가자를 찾을 수 없습니다', 'error');
                    return;
                }

            // Pre-fill with existing data
            const existingReward = currentParticipant.rewardType;

            // Display participant info
            document.getElementById('checkinInfo').innerHTML = `
                <div style="font-weight: 600; font-size: 18px; margin-bottom: 8px;">${currentParticipant.name}</div>
                <div style="color: var(--text-light); font-size: 14px;">
                    <div>🆔 P-${currentParticipant.ID || 'ID 없음'}</div>
                    <div>📅 ${currentParticipant.setDate || ''} ${currentParticipant.setTime || ''}</div>
                    <div>📞 ${currentParticipant.phone || '연락처 없음'}</div>
                    <div style="margin-top: 8px; padding: 8px; background: #e8f8f5; border-radius: 6px;">
                        <strong>Current Status:</strong> Attended<br>
                        <strong>Check-in Time:</strong> ${currentParticipant.checkinTime ? new Date(currentParticipant.checkinTime).toLocaleString('ko-KR') : '-'}<br>
                        <strong>Reward:</strong> ${existingReward === 'Gift-Card' || existingReward === 'MobileVoucher' ? 'Gift-Card' : existingReward === 'Cash' || existingReward === 'Transfer' ? 'Transfer' : 'None'}<br>
                        <strong>A-ID:</strong> ${currentParticipant.aID || 'Not assigned'}
                    </div>
                </div>
            `;

            // Pre-fill A-ID
            document.getElementById('aidInput').value = currentParticipant.aID || '';

            // Set existing reward type
            selectedReward = (existingReward === 'Gift-Card' || existingReward === 'MobileVoucher') ? 'mobile' : (existingReward === 'Cash' || existingReward === 'Transfer') ? 'cash' : '';
            if (selectedReward) {
                document.querySelectorAll('.reward-option').forEach(el => el.classList.remove('selected'));
                document.querySelector(`[data-reward="${selectedReward}"]`).classList.add('selected');
            }

            // Load existing images from localStorage
            const imageKeys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith(`images_${participantId}_`)) {
                    imageKeys.push(key);
                }
            }

            // Clear previous images
            idCardImageFront = null;
            idCardImageBack = null;
            bankbookImage = null;
            document.getElementById('idFrontPreview').innerHTML = '<span style="color: var(--text-light);">📷 No photo</span>';
            document.getElementById('idBackPreview').innerHTML = '<span style="color: var(--text-light);">📷 No photo</span>';
            document.getElementById('bankbookPreview').innerHTML = '<span style="color: var(--text-light);">📷 사진 없음</span>';

            if (imageKeys.length > 0) {
                // Get the latest image set
                const latestKey = imageKeys.sort().pop();
                try {
                    const imageDataString = localStorage.getItem(latestKey);
                    if (!imageDataString) {
                        console.error('No data for key:', latestKey);
                        addDebugLog('이미지 데이터 없음:', { key: latestKey });
                    } else {
                        const imageData = JSON.parse(imageDataString);
                        console.log('Loading existing images:', imageData);
                        addDebugLog('기존 이미지 로드 중:', {
                            hasfront: !!imageData.idCardFront,
                            hasBack: !!imageData.idCardBack,
                            hasBankbook: !!imageData.bankbook
                        });

                        // Display existing images
                        // New structure with front and back
                        if (imageData.idCardFront) {
                            document.getElementById('idFrontPreview').innerHTML = `
                                <img src="${imageData.idCardFront}" alt="ID Card Front" style="width: 100%; height: auto;">
                                <div style="text-align: center; font-size: 12px; color: var(--success); margin-top: 5px;">
                                    ✓ Front image loaded
                                </div>
                            `;
                            fetch(imageData.idCardFront)
                                .then(res => res.blob())
                                .then(blob => { idCardImageFront = blob; })
                                .catch(err => console.error('Failed to load front image:', err));
                        }

                        if (imageData.idCardBack) {
                            document.getElementById('idBackPreview').innerHTML = `
                                <img src="${imageData.idCardBack}" alt="ID Card Back" style="width: 100%; height: auto;">
                                <div style="text-align: center; font-size: 12px; color: var(--success); margin-top: 5px;">
                                    ✓ Back image loaded
                                </div>
                            `;
                            fetch(imageData.idCardBack)
                                .then(res => res.blob())
                                .then(blob => { idCardImageBack = blob; })
                                .catch(err => console.error('Failed to load back image:', err));
                        }

                        if (imageData.bankbook) {
                            document.getElementById('bankbookPreview').innerHTML = `
                                <img src="${imageData.bankbook}" alt="Bankbook" style="width: 100%; height: auto;">
                                <div style="text-align: center; font-size: 12px; color: var(--success); margin-top: 5px;">
                                    ✓ Existing image loaded
                                </div>
                            `;
                            // Convert base64 back to blob for potential re-upload
                            fetch(imageData.bankbook)
                                .then(res => res.blob())
                                .then(blob => { bankbookImage = blob; })
                                .catch(err => console.error('Failed to load bankbook image:', err));
                        }
                    }
                } catch (error) {
                    console.error('Error loading images:', error);
                    addDebugLog('이미지 로드 오류:', error.message);
                }

                // Show bankbook group if cash was selected
                if (selectedReward === 'cash') {
                    document.getElementById('bankbookGroup').style.display = 'block';
                }
            }

                // Update button text
                document.getElementById('submitBtn').textContent = 'Update';
                document.getElementById('submitBtn').disabled = false;

                // Show modal
                document.getElementById('checkinModal').classList.add('active');

                console.log('Edit modal opened successfully');
                addDebugLog('편집 모달 열림');
            } catch (error) {
                console.error('Error in editAttendance:', error);
                addDebugLog('editAttendance 오류:', error.message);
                showNotification('편집 모드를 열 수 없습니다', 'error');
            }
        }

        // Change no-show to attended
        async function changeToAttended(participantId) {
            return ErrorHandler.handle(async () => {
                const participant = allParticipantsData.find(p => p.ID === participantId);
                if (!participant) {
                    throw new Error('Participant not found.');
                }

                // Save to AttendanceImages
                const now = new Date();
                const checkinDateOnly = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;

                const attendanceData = {
                    participantID: parseInt(participant.ID) || 0,
                    participantName: participant.name || '',
                    checkinTime: checkinDateOnly,
                    attendanceStatus: 'Attended',
                    rewardType: 'None',
                    staffName: currentUser.fullName || '',
                    staffID: currentUser.username || '',
                    checkDate: participant.setDate || '',
                    checkTime: participant.setTime || '',
                    notes: `Changed from No-show to Attended - ${now.toLocaleString('en-US')}`
                };

                const response = await fetch(
                    `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${ATTENDANCE_TABLE_ID}`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            records: [{
                                fields: attendanceData
                            }]
                        })
                    }
                );

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(`Failed to update: ${error.error?.message || response.statusText}`);
                }

                // Update local data
                participant.attendanceStatus = 'Attended';
                participant.checkinTime = checkinDateOnly;
                participant.checkinStaff = currentUser.fullName;

                ErrorHandler.showNotification(`${participant.name}'s status has been changed to Attended.`, 'success');
                filterAndDisplayParticipants();
                updateStats();
            }, {
                showNotification: true,
                logError: true
            });
        }

        // Debug function to list all localStorage keys
        window.debugLocalStorage = function() {
            console.log('=== localStorage Debug Info ===');
            console.log('Total items:', localStorage.length);
            const imageKeys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                console.log(`Key ${i}:`, key);
                if (key && key.includes('images_')) {
                    imageKeys.push(key);
                }
            }
            console.log('Image keys found:', imageKeys);
            return imageKeys;
        };

        // View stored images from Airtable
        window.viewImages = async function(participantId) {
            console.log('viewImages called for participant:', participantId);
            addDebugLog('viewImages 호출됨 - Airtable에서 이미지 조회:', { participantId });

            try {
                // Show loading message
                showNotification('이미지를 불러오는 중...', 'info');

                // Fetch from AttendanceImages table with filter
                const filterFormula = `{participantID}=${participantId}`;
                const url = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${ATTENDANCE_TABLE_ID}?filterByFormula=${encodeURIComponent(filterFormula)}`;

                console.log('Fetching images from Airtable:', url);
                addDebugLog('Airtable 이미지 조회 URL:', url);

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_API_KEY}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`Failed to fetch images: ${response.status}`);
                }

                const data = await response.json();
                console.log('Airtable full response:', data);
                if (data.records && data.records.length > 0) {
                    console.log('First record:', data.records[0]);
                    console.log('First record fields:', data.records[0].fields);
                    console.log('All field names:', Object.keys(data.records[0].fields));
                }
                addDebugLog('Airtable 응답 데이터:', {
                    recordCount: data.records.length,
                    firstRecord: data.records[0]?.fields,
                    fieldNames: data.records[0] ? Object.keys(data.records[0].fields) : []
                });

                if (!data.records || data.records.length === 0) {
                    console.log('No records found for participant:', participantId);
                    addDebugLog('참가자 레코드 없음', { participantId });

                    // Try to find participant data to show info
                    const participant = participantsData.find(p => p.ID === participantId);

                    // Show modal with no images message
                    const modal = document.createElement('div');
                    modal.className = 'modal active';
                    modal.style.zIndex = '2000';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width: 600px;">
                            <div class="modal-header">
                                <h3 class="modal-title">이미지 정보</h3>
                                <button class="modal-close" onclick="this.closest('.modal').remove()">×</button>
                            </div>
                            <div class="modal-body">
                                <div style="padding: 20px; text-align: center;">
                                    <div style="font-size: 48px; margin-bottom: 20px;">📷</div>
                                    <h4>저장된 이미지가 없습니다</h4>
                                    ${participant ? `
                                        <div style="margin-top: 20px; padding: 15px; background: #f3f4f6; border-radius: 8px; text-align: left;">
                                            <div style="margin-bottom: 8px;"><strong>참가자:</strong> ${participant.name || 'Unknown'}</div>
                                            <div style="margin-bottom: 8px;"><strong>ID:</strong> ${participantId}</div>
                                            <div style="margin-bottom: 8px;"><strong>체크인 시간:</strong> ${participant.checkinTime ? new Date(participant.checkinTime).toLocaleString('ko-KR') : 'N/A'}</div>
                                            <div><strong>리워드:</strong> ${participant.rewardType || 'None'}</div>
                                        </div>
                                    ` : ''}
                                    <button onclick="this.closest('.modal').remove()" style="margin-top: 20px; padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer;">
                                        닫기
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    return;
                }

                // Get the latest record (if multiple exist)
                const latestRecord = data.records[data.records.length - 1];
                const fields = latestRecord.fields;

                console.log('Image fields from Airtable:', fields);
                console.log('idCardImageFront value:', fields.idCardImageFront);
                console.log('idCardImageBack value:', fields.idCardImageBack);
                console.log('bankbookImage value:', fields.bankbookImage);

                addDebugLog('Airtable 이미지 필드 상세:', {
                    hasIdCardFront: !!fields.idCardImageFront,
                    hasIdCardBack: !!fields.idCardImageBack,
                    hasBankbook: !!fields.bankbookImage,
                    idCardFrontType: typeof fields.idCardImageFront,
                    idCardBackType: typeof fields.idCardImageBack,
                    bankbookType: typeof fields.bankbookImage,
                    idCardFrontValue: fields.idCardImageFront,
                    idCardBackValue: fields.idCardImageBack,
                    bankbookValue: fields.bankbookImage
                });

                // Check if any images exist (only Attachment fields - Base64 fields don't exist in Airtable)
                const hasAttachmentImages = fields.idCardImageFront || fields.idCardImageBack || fields.bankbookImage;

                if (!hasAttachmentImages) {
                    console.log('No images in Airtable record, checking localStorage...');
                    addDebugLog('Airtable에 이미지 없음, localStorage 확인 중...');

                    // Fallback to localStorage
                    const imageKeys = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && (key.startsWith(`images_${participantId}_`) || key.includes(`_${participantId}_`))) {
                            imageKeys.push(key);
                            console.log('Found localStorage image key:', key);
                        }
                    }

                    if (imageKeys.length > 0) {
                        // Found images in localStorage
                        const latestKey = imageKeys.sort().pop();
                        const localImageData = localStorage.getItem(latestKey);

                        if (localImageData) {
                            try {
                                const parsedData = JSON.parse(localImageData);
                                console.log('Found localStorage images:', parsedData);
                                addDebugLog('localStorage에서 이미지 발견', {
                                    hasfront: !!parsedData.idCardFront,
                                    hasBack: !!parsedData.idCardBack,
                                    hasBankbook: !!parsedData.bankbook
                                });

                                // Display localStorage images
                                const modal = document.createElement('div');
                                modal.className = 'modal active';
                                modal.style.zIndex = '2000';
                                modal.innerHTML = `
                                    <div class="modal-content" style="max-width: 700px;">
                                        <div class="modal-header">
                                            <h3 class="modal-title">저장된 이미지 (로컬 저장소)</h3>
                                            <button class="modal-close" onclick="this.closest('.modal').remove()">×</button>
                                        </div>
                                        <div class="modal-body" style="max-height: 80vh; overflow-y: auto;">
                                            <div style="margin-bottom: 15px; padding: 12px; background: #fef3c7; border-radius: 8px;">
                                                <p style="margin: 0; color: #92400e; font-size: 14px;">
                                                    ⚠️ 이 이미지는 브라우저에 임시 저장된 것입니다. 서버에는 아직 업로드되지 않았습니다.
                                                </p>
                                            </div>
                                            <div style="margin-bottom: 15px; padding: 12px; background: #f3f4f6; border-radius: 8px; font-size: 13px;">
                                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                                    <div><strong>참가자:</strong> ${fields.participantName || 'Unknown'}</div>
                                                    <div><strong>ID:</strong> ${participantId}</div>
                                                    <div><strong>체크인:</strong> ${fields.checkinTime || 'N/A'}</div>
                                                    <div><strong>리워드:</strong> ${fields.rewardType || 'None'}</div>
                                                </div>
                                            </div>

                                            ${parsedData.idCardFront ? `
                                                <div style="margin-bottom: 20px;">
                                                    <h4 style="margin-bottom: 10px;">📇 신분증 앞면</h4>
                                                    <img src="${parsedData.idCardFront}" style="width: 100%; border-radius: 8px; border: 1px solid var(--border);">
                                                </div>
                                            ` : '<div style="margin-bottom: 15px; color: var(--text-light);">신분증 앞면 이미지 없음</div>'}

                                            ${parsedData.idCardBack ? `
                                                <div style="margin-bottom: 20px;">
                                                    <h4 style="margin-bottom: 10px;">📇 신분증 뒷면</h4>
                                                    <img src="${parsedData.idCardBack}" style="width: 100%; border-radius: 8px; border: 1px solid var(--border);">
                                                </div>
                                            ` : '<div style="margin-bottom: 15px; color: var(--text-light);">신분증 뒷면 이미지 없음</div>'}

                                            ${parsedData.bankbook ? `
                                                <div style="margin-bottom: 20px;">
                                                    <h4 style="margin-bottom: 10px;">💳 통장사본</h4>
                                                    <img src="${parsedData.bankbook}" style="width: 100%; border-radius: 8px; border: 1px solid var(--border);">
                                                </div>
                                            ` : '<div style="color: var(--text-light);">통장사본 이미지 없음</div>'}
                                        </div>
                                    </div>
                                `;
                                document.body.appendChild(modal);
                                return;
                            } catch (e) {
                                console.error('Failed to parse localStorage image data:', e);
                            }
                        }
                    }

                    console.log('No images found anywhere');
                    showNotification('이 참가자의 이미지가 없습니다', 'warning');

                    // Show info modal
                    const modal = document.createElement('div');
                    modal.className = 'modal active';
                    modal.style.zIndex = '2000';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width: 600px;">
                            <div class="modal-header">
                                <h3 class="modal-title">이미지 정보</h3>
                                <button class="modal-close" onclick="this.closest('.modal').remove()">×</button>
                            </div>
                            <div class="modal-body">
                                <div style="padding: 20px;">
                                    <div style="margin-bottom: 15px; padding: 15px; background: #f3f4f6; border-radius: 8px;">
                                        <div style="margin-bottom: 8px;"><strong>참가자 이름:</strong> ${fields.participantName || 'Unknown'}</div>
                                        <div style="margin-bottom: 8px;"><strong>참가자 ID:</strong> ${fields.participantID || participantId}</div>
                                        <div style="margin-bottom: 8px;"><strong>체크인 시간:</strong> ${fields.checkinTime || 'N/A'}</div>
                                        <div style="margin-bottom: 8px;"><strong>리워드:</strong> ${fields.rewardType || 'None'}</div>
                                        <div><strong>A-ID:</strong> ${fields['A-ID'] || 'Not assigned'}</div>
                                    </div>
                                    <div style="text-align: center; padding: 20px; background: #fef3c7; border-radius: 8px;">
                                        <div style="font-size: 48px; margin-bottom: 10px;">📷</div>
                                        <p style="margin: 0; color: #92400e;">이미지가 업로드되지 않았습니다</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    return;
                }


                // Create modal to display images from Airtable
                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.style.zIndex = '2000';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 700px;">
                        <div class="modal-header">
                            <h3 class="modal-title">저장된 이미지</h3>
                            <button class="modal-close" onclick="this.closest('.modal').remove()">×</button>
                        </div>
                        <div class="modal-body" style="max-height: 80vh; overflow-y: auto;">
                            <div style="margin-bottom: 15px; padding: 12px; background: #f3f4f6; border-radius: 8px; font-size: 13px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                    <div><strong>참가자:</strong> ${fields.participantName || 'Unknown'}</div>
                                    <div><strong>ID:</strong> ${fields.participantID || participantId}</div>
                                    <div><strong>체크인:</strong> ${fields.checkinTime || 'N/A'}</div>
                                    <div><strong>리워드:</strong> ${fields.rewardType || 'None'}</div>
                                    <div><strong>A-ID:</strong> ${fields['A-ID'] || 'Not assigned'}</div>
                                    <div><strong>직원:</strong> ${fields.staffName || 'N/A'}</div>
                                </div>
                            </div>

                            ${fields.idCardImageFront ? `
                                <div style="margin-bottom: 20px;">
                                    <h4 style="margin-bottom: 10px; color: var(--text);">📇 신분증 앞면</h4>
                                    ${Array.isArray(fields.idCardImageFront) && fields.idCardImageFront[0] ? `
                                        <img src="${fields.idCardImageFront[0].url}"
                                             alt="ID Card Front"
                                             style="width: 100%; border-radius: 8px; border: 1px solid var(--border); cursor: pointer;"
                                             onclick="window.open('${fields.idCardImageFront[0].url}', '_blank')">
                                        <div style="margin-top: 5px; font-size: 11px; color: var(--text-light);">
                                            클릭하여 원본 크기로 보기
                                        </div>
                                    ` : `<div style="color: var(--text-light);">이미지 로드 오류</div>`}
                                </div>
                            ` : '<div style="margin-bottom: 15px; padding: 10px; background: #fef3c7; border-radius: 6px; color: #92400e;">⚠️ 신분증 앞면 이미지 없음</div>'}

                            ${fields.idCardImageBack ? `
                                <div style="margin-bottom: 20px;">
                                    <h4 style="margin-bottom: 10px; color: var(--text);">📇 신분증 뒷면</h4>
                                    ${Array.isArray(fields.idCardImageBack) && fields.idCardImageBack[0] ? `
                                        <img src="${fields.idCardImageBack[0].url}"
                                             alt="ID Card Back"
                                             style="width: 100%; border-radius: 8px; border: 1px solid var(--border); cursor: pointer;"
                                             onclick="window.open('${fields.idCardImageBack[0].url}', '_blank')">
                                        <div style="margin-top: 5px; font-size: 11px; color: var(--text-light);">
                                            클릭하여 원본 크기로 보기
                                        </div>
                                    ` : `<div style="color: var(--text-light);">이미지 URL 형식이 올바르지 않습니다</div>`}
                                </div>
                            ` : '<div style="margin-bottom: 15px; padding: 10px; background: #fef3c7; border-radius: 6px; color: #92400e;">⚠️ 신분증 뒷면 이미지 없음</div>'}

                            ${fields.bankbookImage ? `
                                <div style="margin-bottom: 20px;">
                                    <h4 style="margin-bottom: 10px; color: var(--text);">💳 통장사본</h4>
                                    ${Array.isArray(fields.bankbookImage) && fields.bankbookImage[0] ? `
                                        <img src="${fields.bankbookImage[0].url}"
                                             alt="Bankbook"
                                             style="width: 100%; border-radius: 8px; border: 1px solid var(--border); cursor: pointer;"
                                             onclick="window.open('${fields.bankbookImage[0].url}', '_blank')">
                                        <div style="margin-top: 5px; font-size: 11px; color: var(--text-light);">
                                            클릭하여 원본 크기로 보기
                                        </div>
                                    ` : `<div style="color: var(--text-light);">이미지 URL 형식이 올바르지 않습니다</div>`}
                                </div>
                            ` : fields.rewardType === 'Transfer' && fields.bankbookCheck ?
                                '<div style="margin-bottom: 15px; padding: 10px; background: #dbeafe; border-radius: 6px; color: #1e40af;">ℹ️ 통장사본 나중에 확인 예정</div>' :
                                '<div style="margin-bottom: 15px; padding: 10px; background: #fef3c7; border-radius: 6px; color: #92400e;">⚠️ 통장사본 이미지 없음</div>'}
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                console.log('Modal with Airtable images displayed');
                addDebugLog('Airtable 이미지 모달 표시됨', {
                    hasImages: {
                        front: !!fields.idCardImageFront,
                        back: !!fields.idCardImageBack,
                        bankbook: !!fields.bankbookImage
                    }
                });
            } catch (error) {
                console.error('Error in viewImages:', error);
                addDebugLog('viewImages 오류:', error.message);
                showNotification('이미지 표시 중 오류가 발생했습니다', 'error');
            }
        }

        // Show notification
        function showNotification(message, type = 'success') {
            ErrorHandler.showNotification(message, type);
        }

        // Logout
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                sessionStorage.removeItem('clt_session');
                window.location.href = 'login.html';
            }
        }
    </script>
</body>
</html>