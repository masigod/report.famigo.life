<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•„ëª¨ë ˆí¼ì‹œí”½ íŒŒìš´ë°ì´ì…˜ CLT í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ v5.2</title>
    <script src="config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1a1a1a;
            --secondary: #ff6b35;
            --accent: #4ecdc4;
            --warm: #ff9a76;
            --cool: #679bff;
            --neutral: #95a5a6;
            --olive: #8fbc8f;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .header {
            background: var(--bg-gradient);
            color: white;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }

        .stat-card .label {
            font-size: 11px;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .stat-card .value {
            font-size: 28px;
            font-weight: bold;
            background: var(--bg-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-card .detail {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .filters {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 12px;
            color: #666;
        }

        select, input {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--bg-gradient);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .participants-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        .table-container {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            text-align: left;
            font-size: 11px;
            text-transform: uppercase;
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .pid-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            background: #e3f2fd;
            color: #1976d2;
        }

        .pid-badge.pending {
            background: #fff3e0;
            color: #f57c00;
        }

        .tone-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            color: white;
        }

        .tone-cool { background: var(--cool); }
        .tone-warm { background: var(--warm); }
        .tone-neutral { background: var(--neutral); }
        .tone-olive { background: var(--olive); }

        .reserve-badge {
            background: #ffebee;
            color: #c62828;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 5px;
        }

        .action-btn {
            padding: 5px 8px;
            border: none;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s;
            background: #e3f2fd;
            color: #1976d2;
            margin: 0 2px;
        }

        .action-btn:hover {
            background: #1976d2;
            color: white;
        }

        .loading-indicator {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .success-message, .error-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            z-index: 1000;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .success-message {
            background: #28a745;
        }

        .error-message {
            background: #dc3545;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>ğŸ¨ ì•„ëª¨ë ˆí¼ì‹œí”½ íŒŒìš´ë°ì´ì…˜ CLT í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ v5.2</h1>
            <div style="font-size: 14px; opacity: 0.9;">
                Foundation Color Matching CLT - Request/Confirm Date Management + Full Airtable Integration
                <span id="storageIndicator" style="margin-left: 10px; padding: 4px 8px; background: rgba(255,255,255,0.2); border-radius: 4px;">ğŸ’¾ ë¡œì»¬ ì €ì¥ì†Œ</span>
                <span id="syncStatus" style="margin-left: 10px; padding: 4px 8px; background: rgba(40,167,69,0.8); border-radius: 4px;">âœ… ì¤€ë¹„ì™„ë£Œ</span>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Dashboard Stats -->
        <div class="dashboard">
            <div class="stat-card">
                <div class="label">ì´ ì°¸ê°€ì</div>
                <div class="value" id="totalCount">150</div>
                <div class="detail" id="totalDetail">ì •ê·œ: 0 | ì˜ˆë¹„: 0</div>
            </div>
            <div class="stat-card">
                <div class="label">ì¼ìë³„ ë¶„í¬</div>
                <div class="value">5ì¼</div>
                <div class="detail">9/22~26 ê° 30ëª…</div>
            </div>
            <div class="stat-card">
                <div class="label">P-ID ë§¤ì¹­</div>
                <div class="value" id="matchedCount">150</div>
                <div class="detail">ë§¤ì¹­ë¥ : <span id="matchRate">100%</span></div>
            </div>
            <div class="stat-card">
                <div class="label">ìš”ì²­/í™•ì • í˜„í™©</div>
                <div class="value" id="requestConfirmCount">0/0</div>
                <div class="detail" id="requestConfirmDetail">ìš”ì²­: 0ê±´ | í™•ì •: 0ê±´</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters">
            <div class="filter-group">
                <label>ë‚ ì§œ</label>
                <select id="dateFilter">
                    <option value="">ì „ì²´ (9/22-26)</option>
                    <option value="9/22">9/22 (ì›”)</option>
                    <option value="9/23">9/23 (í™”)</option>
                    <option value="9/24">9/24 (ìˆ˜)</option>
                    <option value="9/25">9/25 (ëª©)</option>
                    <option value="9/26">9/26 (ê¸ˆ)</option>
                </select>
            </div>
            <div class="filter-group">
                <label>ì‹œê°„ëŒ€</label>
                <select id="timeFilter">
                    <option value="">ì „ì²´</option>
                    <option value="13:00">13:00-13:30</option>
                    <option value="13:30">13:30-14:00</option>
                    <option value="14:00">14:00-14:30</option>
                    <option value="14:30">14:30-15:00</option>
                    <option value="15:00">15:00-15:30</option>
                    <option value="15:30">15:30-16:00</option>
                </select>
            </div>
            <div class="filter-group">
                <label>íƒ€ê²Ÿ</label>
                <select id="targetFilter">
                    <option value="">ì „ì²´</option>
                    <option value="1(F)">1(F)</option>
                    <option value="2(L)">2(L)</option>
                    <option value="3(LM)">3(LM)</option>
                    <option value="4(M)">4(M)</option>
                    <option value="5(MD)">5(MD)</option>
                    <option value="6(D)">6(D)</option>
                    <option value="7(R)">7(R)</option>
                </select>
            </div>
            <div class="filter-group">
                <label>í†¤</label>
                <select id="toneFilter">
                    <option value="">ì „ì²´</option>
                    <option value="Cool">Cool</option>
                    <option value="Warm">Warm</option>
                    <option value="Neutral">Neutral</option>
                    <option value="Olive">Olive</option>
                </select>
            </div>
            <div class="filter-group">
                <label>ìƒíƒœ</label>
                <select id="statusFilter">
                    <option value="">ì „ì²´</option>
                    <option value="regular">ì •ê·œ</option>
                    <option value="reserve">ì˜ˆë¹„</option>
                </select>
            </div>
            <div class="filter-group">
                <label>í”¼ë“œë°± ìƒíƒœ</label>
                <select id="feedbackFilter">
                    <option value="">ì „ì²´</option>
                    <option value="ëŒ€ê¸°">ğŸ”„ ëŒ€ê¸°</option>
                    <option value="ì „ì†¡">ğŸ“¤ ì „ì†¡</option>
                    <option value="í™•ì •">âœ… í™•ì •</option>
                    <option value="ìˆ˜ì •ìš”ì²­">ğŸ“ ìˆ˜ì •ìš”ì²­</option>
                </select>
            </div>
            <div class="filter-group" style="flex: 1;">
                <label>ê²€ìƒ‰ (ì´ë¦„)</label>
                <input type="text" placeholder="Elena, Madison..." id="searchInput">
            </div>
            <button class="btn btn-primary" onclick="showCSVData()">ğŸ“„ CSV ë°ì´í„° ë³´ê¸°</button>
            <button class="btn btn-success" onclick="showAddParticipantForm()">â• ìƒˆ ì°¸ê°€ì ì¶”ê°€</button>
            <button class="btn btn-warning" onclick="resetLocalStorage()">ğŸ”„ ë°ì´í„° ì´ˆê¸°í™”</button>
        </div>

        <!-- Table -->
        <div class="participants-table">
            <div class="table-container">
                <table id="participantsTable">
                    <thead>
                        <tr>
                            <th width="40">ID</th>
                            <th width="80">P-ID</th>
                            <th width="80">ë‚ ì§œ</th>
                            <th width="80">ì‹œê°„</th>
                            <th>ì´ë¦„</th>
                            <th width="60">íƒ€ê²Ÿ</th>
                            <th width="80">í†¤</th>
                            <th>ì „í™”ë²ˆí˜¸</th>
                            <th>ì´ë©”ì¼</th>
                            <th width="60">ì˜ˆë¹„ì—¬ë¶€</th>
                            <th width="120">í”¼ë“œë°±ìƒíƒœ</th>
                            <th width="120">ìš”ì²­ì¼ì</th>
                            <th width="120">í™•ì •ì¼ì</th>
                            <th width="180">ë¹„ê³ </th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="14" class="loading-indicator">ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div style="margin-top: 20px; padding: 10px; background: white; border-radius: 8px; text-align: center;">
            <span id="statusBar" style="color: #666; font-size: 14px;">ì´ <span id="totalParticipants">150</span>ëª… ì¤‘ <span id="displayCount">0</span>ëª… í‘œì‹œ</span>
        </div>
    </div>

    <!-- ìƒˆ ì°¸ê°€ì ì¶”ê°€ ëª¨ë‹¬ -->
    <div id="addParticipantModal" onclick="closeModalOnBackdrop(event)" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
        <div onclick="event.stopPropagation();" style="background: white; margin: 50px auto; padding: 30px; border-radius: 12px; max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h2 style="margin: 0; color: #333;">â• ìƒˆ ì°¸ê°€ì ì¶”ê°€</h2>
                <button onclick="hideAddParticipantForm()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">Ã—</button>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">ì°¸ê°€ìëª… *</label>
                    <input type="text" id="newName" placeholder="ì°¸ê°€ì ì´ë¦„" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">ë‚ ì§œ *</label>
                    <select id="newDate" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="9/22">9/22 (ì›”)</option>
                        <option value="9/23">9/23 (í™”)</option>
                        <option value="9/24">9/24 (ìˆ˜)</option>
                        <option value="9/25">9/25 (ëª©)</option>
                        <option value="9/26">9/26 (ê¸ˆ)</option>
                    </select>
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">ì‹œê°„ *</label>
                    <select id="newTime" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="13:00">13:00</option>
                        <option value="13:30">13:30</option>
                        <option value="14:00">14:00</option>
                        <option value="14:30">14:30</option>
                        <option value="15:00">15:00</option>
                        <option value="15:30">15:30</option>
                    </select>
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">íƒ€ê²Ÿ *</label>
                    <select id="newTarget" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="1(F)">1(F)</option>
                        <option value="2(L)">2(L)</option>
                        <option value="3(LM)">3(LM)</option>
                        <option value="4(M)">4(M)</option>
                        <option value="5(MD)">5(MD)</option>
                        <option value="6(D)">6(D)</option>
                        <option value="7(R)">7(R)</option>
                    </select>
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">í†¤</label>
                    <select id="newTone" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="Cool">Cool</option>
                        <option value="Warm">Warm</option>
                        <option value="Neutral">Neutral</option>
                        <option value="Olive">Olive</option>
                    </select>
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">ì „í™”ë²ˆí˜¸</label>
                    <input type="text" id="newPhone" placeholder="ì „í™”ë²ˆí˜¸" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                </div>
                
                <div style="grid-column: 1 / -1;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">ì´ë©”ì¼</label>
                    <input type="email" id="newEmail" placeholder="ì´ë©”ì¼ ì£¼ì†Œ" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">P-ID</label>
                    <input type="text" id="newPID" placeholder="P018, P019..." style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                </div>
                
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="newReserve" style="transform: scale(1.2);">
                    <label for="newReserve" style="font-weight: 600; color: #555;">ì˜ˆë¹„ ì°¸ê°€ì</label>
                </div>
                
                <div style="grid-column: 1 / -1;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">ë¹„ê³ </label>
                    <textarea id="newNotes" placeholder="íŠ¹ì´ì‚¬í•­ì´ë‚˜ ìš”ì²­ì‚¬í•­..." style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; height: 80px; resize: vertical;"></textarea>
                </div>
            </div>
            
            <div style="margin-top: 25px; display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="hideAddParticipantForm()" style="padding: 12px 24px; border: 2px solid #ddd; background: white; border-radius: 8px; cursor: pointer; font-weight: 600;">ì·¨ì†Œ</button>
                <button onclick="addNewParticipant()" style="padding: 12px 24px; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; cursor: pointer; font-weight: 600;">â• ì¶”ê°€í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        // Airtable ì„¤ì • (config.jsì—ì„œ ê°€ì ¸ì˜´)
        const AIRTABLE_API_KEY = typeof AIRTABLE_CONFIG !== 'undefined' ? AIRTABLE_CONFIG.API_KEY : 'YOUR_API_KEY_HERE';
        const AIRTABLE_BASE_ID = typeof AIRTABLE_CONFIG !== 'undefined' ? AIRTABLE_CONFIG.BASE_ID : 'appZcPs57spwdoKQH';
        const AIRTABLE_TABLE_ID = typeof AIRTABLE_CONFIG !== 'undefined' ? AIRTABLE_CONFIG.TABLE_ID : 'tblxMzwX1wWJKIOhY';
        const AIRTABLE_API_URL = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_ID}`;

        // ì „ì—­ ë³€ìˆ˜
        let participantsData = [];
        let airtableRecords = {}; // Record ID ì €ì¥ìš©

        // Airtableì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        async function fetchAirtableData() {
            console.log('Airtable ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹œì‘...');
            console.log('API URL:', AIRTABLE_API_URL);

            try {
                const response = await fetch(AIRTABLE_API_URL + '?maxRecords=100&view=Grid%20view', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }

                const data = await response.json();
                console.log('ë°›ì€ ë°ì´í„°:', data);

                if (!data.records || data.records.length === 0) {
                    console.log('ë ˆì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤. ìƒ˜í”Œ ë°ì´í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.');
                    // ìƒ˜í”Œ ë°ì´í„° ì‚¬ìš©
                    participantsData = [
                        {ID: 1, setDate: "9/22", setTime: "13:00", name: "í…ŒìŠ¤íŠ¸ ì°¸ê°€ì 1", skinColor: "2(L)", skinTone: "Cool", phone: "010-1234-5678", email: "test1@example.com", ì˜ˆë¹„ì—¬ë¶€: false, PID: "P001", status: "ëŒ€ê¸°", requestDate: "", confirmedDate: "", desc: ""},
                        {ID: 2, setDate: "9/22", setTime: "13:30", name: "í…ŒìŠ¤íŠ¸ ì°¸ê°€ì 2", skinColor: "3(LM)", skinTone: "Warm", phone: "010-2345-6789", email: "test2@example.com", ì˜ˆë¹„ì—¬ë¶€: false, PID: "P002", status: "ëŒ€ê¸°", requestDate: "", confirmedDate: "", desc: ""},
                        {ID: 3, setDate: "9/23", setTime: "14:00", name: "í…ŒìŠ¤íŠ¸ ì°¸ê°€ì 3", skinColor: "4(M)", skinTone: "Neutral", phone: "010-3456-7890", email: "test3@example.com", ì˜ˆë¹„ì—¬ë¶€: true, PID: "P003", status: "ëŒ€ê¸°", requestDate: "", confirmedDate: "", desc: ""}
                    ];
                    document.getElementById('syncStatus').innerHTML = 'âš ï¸ ìƒ˜í”Œ ë°ì´í„°';
                } else {
                    // Airtable ë°ì´í„°ë¥¼ ë‚´ë¶€ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                    participantsData = data.records.map(record => {
                        console.log('Processing record:', record);
                        airtableRecords[record.fields.ID || record.id] = record.id;
                        return {
                            ID: record.fields.ID || parseInt(record.id.slice(-3)) || 0,
                            setDate: record.fields.setDate || '',
                            setTime: record.fields.setTime || '',
                            name: record.fields.name || '',
                            skinColor: record.fields.skinColor || '',
                            skinTone: record.fields.skinTone || '',
                            phone: record.fields.phone || '',
                            email: record.fields.email || '',
                            ì˜ˆë¹„ì—¬ë¶€: record.fields.reserveStatus === true || record.fields.reserveStatus === 'true',
                            PID: record.fields['P-ID'] || record.fields.PID || '',
                            status: record.fields.status || 'ëŒ€ê¸°',
                            requestDate: record.fields.requestDate || '',
                            confirmedDate: record.fields.confirmedDate || '',
                            desc: record.fields.desc || ''
                        };
                    });
                    document.getElementById('syncStatus').innerHTML = 'âœ… Airtable ì—°ë™';
                }

                console.log('ì²˜ë¦¬ëœ ë°ì´í„°:', participantsData);
                loadParticipants();
                updateStats();

            } catch (error) {
                console.error('Airtable ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);

                // CORS ì—ëŸ¬ì¼ ê²½ìš° ì•ˆë‚´
                if (error.message.includes('Failed to fetch') || error.message.includes('CORS')) {
                    showNotification('CORS ì—ëŸ¬: ë¡œì»¬ì—ì„œëŠ” ìƒ˜í”Œ ë°ì´í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ë°°í¬ í›„ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤.', 'error');

                    // ìƒ˜í”Œ ë°ì´í„°ë¡œ ëŒ€ì²´
                    participantsData = [
                        {ID: 1, setDate: "9/22", setTime: "13:00", name: "ìƒ˜í”Œ ì°¸ê°€ì 1", skinColor: "2(L)", skinTone: "Cool", phone: "010-1234-5678", email: "sample1@example.com", ì˜ˆë¹„ì—¬ë¶€: false, PID: "P001", status: "ëŒ€ê¸°", requestDate: "", confirmedDate: "", desc: ""},
                        {ID: 2, setDate: "9/22", setTime: "13:30", name: "ìƒ˜í”Œ ì°¸ê°€ì 2", skinColor: "3(LM)", skinTone: "Warm", phone: "010-2345-6789", email: "sample2@example.com", ì˜ˆë¹„ì—¬ë¶€: false, PID: "P002", status: "ëŒ€ê¸°", requestDate: "", confirmedDate: "", desc: ""},
                        {ID: 3, setDate: "9/23", setTime: "14:00", name: "ìƒ˜í”Œ ì°¸ê°€ì 3", skinColor: "4(M)", skinTone: "Neutral", phone: "010-3456-7890", email: "sample3@example.com", ì˜ˆë¹„ì—¬ë¶€: true, PID: "P003", status: "ëŒ€ê¸°", requestDate: "", confirmedDate: "", desc: ""}
                    ];
                    document.getElementById('syncStatus').innerHTML = 'âš ï¸ ìƒ˜í”Œ ë°ì´í„° (CORS)';
                    loadParticipants();
                    updateStats();
                } else {
                    showNotification('Airtable ì—°ê²° ì‹¤íŒ¨: ' + error.message, 'error');
                    document.getElementById('syncStatus').innerHTML = 'âŒ ì—°ê²° ì‹¤íŒ¨';
                }
            }
        }

        // Airtable ë ˆì½”ë“œ ì—…ë°ì´íŠ¸
        async function updateAirtableRecord(participantId, fieldName, value) {
            const recordId = airtableRecords[participantId];
            if (!recordId) {
                console.error('Record ID not found for participant:', participantId);
                return false;
            }

            try {
                const response = await fetch(`${AIRTABLE_API_URL}/${recordId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fields: {
                            [fieldName]: value
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                return true;
            } catch (error) {
                console.error('Airtable ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
                showNotification('ë°ì´í„° ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + error.message, 'error');
                return false;
            }
        }

        // Airtableì— ìƒˆ ë ˆì½”ë“œ ì¶”ê°€
        async function createAirtableRecord(participant) {
            try {
                const response = await fetch(AIRTABLE_API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        records: [{
                            fields: {
                                ID: participant.ID,
                                name: participant.name,
                                setDate: participant.setDate,
                                setTime: participant.setTime,
                                skinColor: participant.skinColor,
                                skinTone: participant.skinTone || '',
                                phone: participant.phone || '',
                                email: participant.email || '',
                                reserveStatus: participant.ì˜ˆë¹„ì—¬ë¶€,
                                'P-ID': participant.PID || '',
                                status: participant.status || 'ëŒ€ê¸°',
                                requestDate: participant.requestDate || '',
                                confirmedDate: participant.confirmedDate || '',
                                desc: participant.desc || ''
                            }
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (data.records && data.records.length > 0) {
                    airtableRecords[participant.ID] = data.records[0].id;
                }

                return true;
            } catch (error) {
                console.error('Airtable ë ˆì½”ë“œ ìƒì„± ì‹¤íŒ¨:', error);
                showNotification('ìƒˆ ì°¸ê°€ì ì¶”ê°€ ì‹¤íŒ¨: ' + error.message, 'error');
                return false;
            }
        }

        // ê¸°ë³¸ í•¨ìˆ˜ë“¤
        function loadParticipants() {
            const tbody = document.getElementById('tableBody');
            const dateFilter = document.getElementById('dateFilter').value;
            const timeFilter = document.getElementById('timeFilter').value;
            const targetFilter = document.getElementById('targetFilter').value;
            const toneFilter = document.getElementById('toneFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const feedbackFilter = document.getElementById('feedbackFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            let filtered = participantsData.filter(p => {
                if (dateFilter && p.setDate !== dateFilter) return false;
                if (timeFilter && p.setTime !== timeFilter) return false;
                if (targetFilter && p.skinColor !== targetFilter) return false;
                if (toneFilter && p.skinTone !== toneFilter) return false;
                if (statusFilter) {
                    if (statusFilter === 'regular' && p.ì˜ˆë¹„ì—¬ë¶€) return false;
                    if (statusFilter === 'reserve' && !p.ì˜ˆë¹„ì—¬ë¶€) return false;
                }
                if (feedbackFilter && p.status !== feedbackFilter) return false;
                if (searchTerm && !p.name.toLowerCase().includes(searchTerm)) return false;
                return true;
            });

            const html = filtered.map(p => `
                <tr>
                    <td>${p.ID}</td>
                    <td><span class="pid-badge">${p.PID || 'ëŒ€ê¸°'}</span></td>
                    <td>${p.setDate}</td>
                    <td>${p.setTime}</td>
                    <td>
                        ${p.name}
                        ${p.ì˜ˆë¹„ì—¬ë¶€ ? '<span class="reserve-badge">ì˜ˆë¹„</span>' : ''}
                    </td>
                    <td>${p.skinColor}</td>
                    <td>${p.skinTone ? `<span class="tone-badge tone-${p.skinTone.toLowerCase()}">${p.skinTone}</span>` : '-'}</td>
                    <td>${p.phone?.substring(0, 15) || '-'}</td>
                    <td>${p.email?.substring(0, 25) || '-'}</td>
                    <td>${p.ì˜ˆë¹„ì—¬ë¶€ ? 'ì˜ˆë¹„' : 'ì •ê·œ'}</td>
                    <td>
                        <select onchange="updateFeedbackStatus(${p.ID}, this.value)" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                            <option value="ëŒ€ê¸°" ${p.status === 'ëŒ€ê¸°' ? 'selected' : ''}>ğŸ”„ ëŒ€ê¸°</option>
                            <option value="ì „ì†¡" ${p.status === 'ì „ì†¡' ? 'selected' : ''}>ğŸ“¤ ì „ì†¡</option>
                            <option value="í™•ì •" ${p.status === 'í™•ì •' ? 'selected' : ''}>âœ… í™•ì •</option>
                            <option value="ìˆ˜ì •ìš”ì²­" ${p.status === 'ìˆ˜ì •ìš”ì²­' ? 'selected' : ''}>ğŸ“ ìˆ˜ì •ìš”ì²­</option>
                        </select>
                    </td>
                    <td>
                        <input type="date" value="${p.requestDate || ''}" onchange="updateRequestDate(${p.ID}, this.value)" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; width: 110px;">
                    </td>
                    <td>
                        <input type="date" value="${p.confirmedDate || ''}" onchange="updateConfirmDate(${p.ID}, this.value)" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; width: 110px;">
                    </td>
                    <td>
                        <input type="text" value="${p.desc || ''}" onchange="updateNotes(${p.ID}, this.value)" placeholder="ë¹„ê³ ..." style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; width: 160px;">
                    </td>
                </tr>
            `).join('');

            tbody.innerHTML = html || '<tr><td colspan="14" style="text-align: center; padding: 40px;">í•„í„° ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
            
            document.getElementById('displayCount').textContent = filtered.length;
            document.getElementById('totalParticipants').textContent = participantsData.length;
        }

        function updateStats() {
            const total = participantsData.length;
            const regular = participantsData.filter(p => !p.ì˜ˆë¹„ì—¬ë¶€).length;
            const reserve = participantsData.filter(p => p.ì˜ˆë¹„ì—¬ë¶€).length;
            const matched = participantsData.filter(p => p.PID && p.PID !== '').length;
            const matchRate = total > 0 ? Math.round((matched / total) * 100) : 0;

            const requestCount = participantsData.filter(p => p.requestDate && p.requestDate.trim() !== '').length;
            const confirmCount = participantsData.filter(p => p.confirmedDate && p.confirmedDate.trim() !== '').length;

            document.getElementById('totalCount').textContent = total;
            document.getElementById('totalDetail').textContent = `ì •ê·œ: ${regular} | ì˜ˆë¹„: ${reserve}`;
            document.getElementById('matchedCount').textContent = matched;
            document.getElementById('matchRate').textContent = `${matchRate}%`;
            document.getElementById('requestConfirmCount').textContent = `${requestCount}/${confirmCount}`;
            document.getElementById('requestConfirmDetail').textContent = `ìš”ì²­: ${requestCount}ê±´ | í™•ì •: ${confirmCount}ê±´`;
        }

        async function updateFeedbackStatus(participantId, newStatus) {
            const participant = participantsData.find(p => p.ID === participantId);
            if (participant) {
                participant.status = newStatus;

                // Airtable ì—…ë°ì´íŠ¸
                const success = await updateAirtableRecord(participantId, 'status', newStatus);
                if (success) {
                    showNotification(`${participant.name}ì˜ í”¼ë“œë°± ìƒíƒœê°€ '${newStatus}'ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                }
                updateStats();
            }
        }

        async function updateRequestDate(participantId, newDate) {
            const participant = participantsData.find(p => p.ID === participantId);
            if (participant) {
                participant.requestDate = newDate;

                // Airtable ì—…ë°ì´íŠ¸
                const success = await updateAirtableRecord(participantId, 'requestDate', newDate);

                if (newDate && newDate.trim() !== '') {
                    participant.status = 'ìˆ˜ì •ìš”ì²­';
                    await updateAirtableRecord(participantId, 'status', 'ìˆ˜ì •ìš”ì²­');
                    loadParticipants(); // í™”ë©´ ìƒˆë¡œê³ ì¹¨
                }

                if (success) {
                    showNotification(`${participant.name}ì˜ ìš”ì²­ì¼ìê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                }
                updateStats();
            }
        }

        async function updateConfirmDate(participantId, newDate) {
            const participant = participantsData.find(p => p.ID === participantId);
            if (participant) {
                participant.confirmedDate = newDate;

                // Airtable ì—…ë°ì´íŠ¸
                const success = await updateAirtableRecord(participantId, 'confirmedDate', newDate);

                if (newDate && newDate.trim() !== '') {
                    participant.status = 'í™•ì •';
                    await updateAirtableRecord(participantId, 'status', 'í™•ì •');
                    loadParticipants(); // í™”ë©´ ìƒˆë¡œê³ ì¹¨
                }

                if (success) {
                    showNotification(`${participant.name}ì˜ í™•ì •ì¼ìê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                }
                updateStats();
            }
        }

        async function updateNotes(participantId, newNotes) {
            const participant = participantsData.find(p => p.ID === participantId);
            if (participant) {
                participant.desc = newNotes;

                // Airtable ì—…ë°ì´íŠ¸
                await updateAirtableRecord(participantId, 'desc', newNotes);
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = type === 'success' ? 'success-message' : 'error-message';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function showCSVData() {
            const headers = ['ID', 'name', 'setDate', 'setTime', 'skinColor', 'skinTone', 'phone', 'email', 'reserveStatus', 'P-ID', 'status', 'requestDate', 'confirmedDate', 'desc'];
            
            let csvContent = headers.join(',') + '\n';
            
            participantsData.forEach(p => {
                const row = [
                    p.ID || '',
                    `"${p.name || ''}"`,
                    p.setDate || '',
                    p.setTime || '',
                    p.skinColor || '',
                    p.skinTone || '',
                    p.phone || '',
                    p.email || '',
                    p.ì˜ˆë¹„ì—¬ë¶€ ? 'TRUE' : 'FALSE',
                    p.PID || '',
                    p.status || 'ëŒ€ê¸°',
                    p.requestDate || '',
                    p.confirmedDate || '',
                    `"${p.desc || ''}"`
                ];
                csvContent += row.join(',') + '\n';
            });
            
            const modal = document.createElement('div');
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;';
            
            const content = document.createElement('div');
            content.onclick = (e) => e.stopPropagation();
            content.style.cssText = 'background: white; margin: 50px auto; padding: 30px; border-radius: 12px; max-width: 90%; max-height: 80vh; overflow-y: auto;';
            
            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">ğŸ“„ CSV ë°ì´í„° (${participantsData.length}ëª…)</h2>
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">Ã—</button>
                </div>
                <textarea readonly style="width: 100%; height: 400px; font-family: monospace; font-size: 12px; border: 2px solid #e0e0e0; border-radius: 8px; padding: 10px;">${csvContent}</textarea>
                <div style="margin-top: 15px; text-align: right;">
                    <button onclick="navigator.clipboard.writeText(this.parentElement.previousElementSibling.value).then(() => { alert('âœ… CSV ë°ì´í„°ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!'); })" style="padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">ğŸ“‹ í´ë¦½ë³´ë“œ ë³µì‚¬</button>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }

        function showAddParticipantForm() {
            document.getElementById('addParticipantModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function hideAddParticipantForm() {
            document.getElementById('addParticipantModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            
            // í¼ ì´ˆê¸°í™”
            document.getElementById('newName').value = '';
            document.getElementById('newDate').value = '';
            document.getElementById('newTime').value = '';
            document.getElementById('newTarget').value = '';
            document.getElementById('newTone').value = '';
            document.getElementById('newPhone').value = '';
            document.getElementById('newEmail').value = '';
            document.getElementById('newPID').value = '';
            document.getElementById('newReserve').checked = false;
            document.getElementById('newNotes').value = '';
        }

        function closeModalOnBackdrop(event) {
            if (event.target === event.currentTarget) {
                hideAddParticipantForm();
            }
        }

        async function addNewParticipant() {
            const name = document.getElementById('newName').value.trim();
            const setDate = document.getElementById('newDate').value;
            const setTime = document.getElementById('newTime').value;
            const skinColor = document.getElementById('newTarget').value;

            if (!name || !setDate || !setTime || !skinColor) {
                alert('âš ï¸ í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.\n(ì°¸ê°€ìëª…, ë‚ ì§œ, ì‹œê°„, íƒ€ê²Ÿ)');
                return;
            }

            const maxId = Math.max(...participantsData.map(p => p.ID), 0);
            const newId = maxId + 1;

            const newParticipant = {
                ID: newId,
                setDate: setDate,
                setTime: setTime,
                name: name,
                skinColor: skinColor,
                skinTone: document.getElementById('newTone').value || '',
                phone: document.getElementById('newPhone').value || '',
                email: document.getElementById('newEmail').value || '',
                ì˜ˆë¹„ì—¬ë¶€: document.getElementById('newReserve').checked,
                PID: document.getElementById('newPID').value.trim() || '',
                status: 'ëŒ€ê¸°',
                requestDate: '',
                confirmedDate: '',
                desc: document.getElementById('newNotes').value || ''
            };

            // Airtableì— ì¶”ê°€
            const success = await createAirtableRecord(newParticipant);

            if (success) {
                participantsData.push(newParticipant);
                loadParticipants();
                updateStats();
                hideAddParticipantForm();
                showNotification(`ìƒˆ ì°¸ê°€ì '${name}'ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤! (ID: ${newId})`, 'success');
            }
        }

        async function resetLocalStorage() {
            if (confirm('âš ï¸ Airtableì—ì„œ ìµœì‹  ë°ì´í„°ë¥¼ ë‹¤ì‹œ ê°€ì ¸ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                await fetchAirtableData();
                showNotification('âœ… Airtableì—ì„œ ë°ì´í„°ë¥¼ ìƒˆë¡œê³ ì¹¨í–ˆìŠµë‹ˆë‹¤.', 'success');
            }
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupEventListeners() {
            document.getElementById('dateFilter').addEventListener('change', loadParticipants);
            document.getElementById('timeFilter').addEventListener('change', loadParticipants);
            document.getElementById('targetFilter').addEventListener('change', loadParticipants);
            document.getElementById('toneFilter').addEventListener('change', loadParticipants);
            document.getElementById('statusFilter').addEventListener('change', loadParticipants);
            document.getElementById('feedbackFilter').addEventListener('change', loadParticipants);
            document.getElementById('searchInput').addEventListener('input', loadParticipants);
        }

        // í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async function() {
            document.getElementById('tableBody').innerHTML = '<tr><td colspan="14" class="loading-indicator">Airtableì—ì„œ ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘...</td></tr>';
            await fetchAirtableData();
            setupEventListeners();
        });
    </script>
</body>
</html>