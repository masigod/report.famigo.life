<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•„ëª¨ë ˆí¼ì‹œí”½ íŒŒìš´ë°ì´ì…˜ CLT í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ v5.2</title>
    <script src="env-config.js"></script>
    <script src="config-loader.js"></script>
    <script src="config.js"></script>
    <script src="security-utils.js"></script>
    <script src="error-handler.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1a1a1a;
            --secondary: #ff6b35;
            --accent: #4ecdc4;
            --warm: #ff9a76;
            --cool: #679bff;
            --neutral: #95a5a6;
            --olive: #8fbc8f;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .header {
            background: var(--bg-gradient);
            color: white;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .stat-card .label {
            font-size: 10px;
            color: #666;
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        .stat-card .value {
            font-size: 20px;
            font-weight: bold;
            background: var(--bg-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-card .detail {
            font-size: 10px;
            color: #999;
            margin-top: 2px;
        }

        .filters {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 12px;
            color: #666;
        }

        select, input {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--bg-gradient);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .participants-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        .table-container {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            text-align: left;
            font-size: 11px;
            text-transform: uppercase;
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .pid-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            background: #e3f2fd;
            color: #1976d2;
        }

        .pid-badge.pending {
            background: #fff3e0;
            color: #f57c00;
        }

        .tone-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            color: white;
        }

        .tone-cool { background: var(--cool); }
        .tone-warm { background: var(--warm); }
        .tone-neutral { background: var(--neutral); }
        .tone-olive { background: var(--olive); }

        .reserve-badge {
            background: #fff3e0;
            color: #e65100;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 5px;
            border: 1px solid #ffb74d;
        }

        tr.reserve-row {
            background-color: #fff8e1 !important;
        }

        tr.reserve-row:hover {
            background-color: #fff3e0 !important;
        }

        .action-btn {
            padding: 5px 8px;
            border: none;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s;
            background: #e3f2fd;
            color: #1976d2;
            margin: 0 2px;
        }

        .action-btn:hover {
            background: #1976d2;
            color: white;
        }

        .loading-indicator {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .success-message, .error-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            z-index: 1000;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .success-message {
            background: #28a745;
        }

        .error-message {
            background: #dc3545;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1>ğŸ¨ ì•„ëª¨ë ˆí¼ì‹œí”½ íŒŒìš´ë°ì´ì…˜ CLT í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ v5.2</h1>
                <div style="font-size: 14px; opacity: 0.9;">
                    Foundation Color Matching CLT - Request/Confirm Date Management + Full Airtable Integration
                    <span id="storageIndicator" style="margin-left: 10px; padding: 4px 8px; background: rgba(255,255,255,0.2); border-radius: 4px;">ğŸ’¾ ë¡œì»¬ ì €ì¥ì†Œ</span>
                    <span id="syncStatus" style="margin-left: 10px; padding: 4px 8px; background: rgba(40,167,69,0.8); border-radius: 4px;">âœ… ì¤€ë¹„ì™„ë£Œ</span>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 15px;">
                <span id="userInfo" style="font-size: 14px; color: white; opacity: 0.9;"></span>
                <button onclick="logout()" style="padding: 8px 16px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); border-radius: 5px; color: white; cursor: pointer; font-weight: 500; transition: background 0.2s;">Logout</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Dashboard Stats -->
        <div class="dashboard">
            <div class="stat-card">
                <div class="label">ì´ ì°¸ê°€ì</div>
                <div class="value" id="totalCount">150</div>
                <div class="detail" id="totalDetail">ì •ê·œ: 0 | ì˜ˆë¹„: 0</div>
            </div>
            <div class="stat-card">
                <div class="label">ì¼ìë³„ ë¶„í¬</div>
                <div class="value" id="dateDistribution">5ì¼</div>
                <div class="detail" id="dateDistributionDetail">9/22~26 ê° 30ëª…</div>
            </div>
            <div class="stat-card">
                <div class="label">P-ID ë§¤ì¹­</div>
                <div class="value" id="matchedCount">150</div>
                <div class="detail">ë§¤ì¹­ë¥ : <span id="matchRate">100%</span></div>
            </div>
            <div class="stat-card">
                <div class="label">ìš”ì²­/í™•ì • í˜„í™©</div>
                <div class="value" id="requestConfirmCount">0/0</div>
                <div class="detail" id="requestConfirmDetail">ìš”ì²­: 0ê±´ | í™•ì •: 0ê±´</div>
            </div>
        </div>

        <!-- Feedback Status Summary -->
        <div class="dashboard" style="margin-bottom: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 10px; border-radius: 8px;">
            <div style="grid-column: 1 / -1; color: white; font-size: 14px; font-weight: 600; margin-bottom: 8px;">
                í”¼ë“œë°± ìƒíƒœ í˜„í™© <span id="selectedDateDisplay" style="font-weight: normal; opacity: 0.9;"></span>
            </div>
            <div class="stat-card" style="background: rgba(255,255,255,0.95); padding: 8px;">
                <div class="label" style="font-size: 10px;">ğŸ”„ Pending</div>
                <div class="value" style="font-size: 18px;" id="pendingCount">0</div>
                <div class="detail" style="font-size: 9px;" id="pendingPercent">0%</div>
            </div>
            <div class="stat-card" style="background: rgba(255,255,255,0.95); padding: 8px;">
                <div class="label" style="font-size: 10px;">ğŸ”§ Ongoing</div>
                <div class="value" style="font-size: 18px;" id="ongoingCount">0</div>
                <div class="detail" style="font-size: 9px;" id="ongoingPercent">0%</div>
            </div>
            <div class="stat-card" style="background: rgba(255,255,255,0.95); padding: 8px;">
                <div class="label" style="font-size: 10px;">ğŸ“¤ Sent</div>
                <div class="value" style="font-size: 18px;" id="sentCount">0</div>
                <div class="detail" style="font-size: 9px;" id="sentPercent">0%</div>
            </div>
            <div class="stat-card" style="background: rgba(255,255,255,0.95); padding: 8px;">
                <div class="label" style="font-size: 10px;">âœ… Confirmed</div>
                <div class="value" style="font-size: 18px;" id="confirmedCount">0</div>
                <div class="detail" style="font-size: 9px;" id="confirmedPercent">0%</div>
            </div>
            <div class="stat-card" style="background: rgba(255,255,255,0.95); padding: 8px;">
                <div class="label" style="font-size: 10px;">ğŸ“ Requested</div>
                <div class="value" style="font-size: 18px;" id="requestedCount">0</div>
                <div class="detail" style="font-size: 9px;" id="requestedPercent">0%</div>
            </div>
            <div class="stat-card" style="background: rgba(255,255,255,0.95); padding: 8px;">
                <div class="label" style="font-size: 10px;">âŒ Cancelled</div>
                <div class="value" style="font-size: 18px;" id="cancelledCount">0</div>
                <div class="detail" style="font-size: 9px;" id="cancelledPercent">0%</div>
            </div>
            <div class="stat-card" style="background: rgba(255,255,255,0.95); padding: 8px;">
                <div class="label" style="font-size: 10px;">ğŸ” Duplicate</div>
                <div class="value" style="font-size: 18px;" id="duplicateCount">0</div>
                <div class="detail" style="font-size: 9px;" id="duplicatePercent">0%</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters">
            <div class="filter-group">
                <label>ë‚ ì§œ</label>
                <select id="dateFilter">
                    <option value="">ì „ì²´</option>
                    <option value="9/22">9/22 (ì›”)</option>
                    <option value="9/23">9/23 (í™”)</option>
                    <option value="9/24">9/24 (ìˆ˜)</option>
                    <option value="9/25">9/25 (ëª©)</option>
                    <option value="9/26">9/26 (ê¸ˆ)</option>
                </select>
            </div>
            <div class="filter-group">
                <label>ì‹œê°„ëŒ€</label>
                <select id="timeFilter">
                    <option value="">ì „ì²´</option>
                    <option value="13:00">13:00-13:30</option>
                    <option value="13:30">13:30-14:00</option>
                    <option value="14:00">14:00-14:30</option>
                    <option value="14:30">14:30-15:00</option>
                    <option value="15:00">15:00-15:30</option>
                    <option value="15:30">15:30-16:00</option>
                    <option value="16:00">16:00-16:30</option>
                    <option value="16:30">16:30-17:00</option>
                </select>
            </div>
            <div class="filter-group">
                <label>íƒ€ê²Ÿ</label>
                <select id="targetFilter">
                    <option value="">ì „ì²´</option>
                    <option value="1(F)">1(F)</option>
                    <option value="2(L)">2(L)</option>
                    <option value="3(LM)">3(LM)</option>
                    <option value="4(M)">4(M)</option>
                    <option value="5(MD)">5(MD)</option>
                    <option value="6(D)">6(D)</option>
                    <option value="7(R)">7(R)</option>
                </select>
            </div>
            <div class="filter-group">
                <label>í†¤</label>
                <select id="toneFilter">
                    <option value="">ì „ì²´</option>
                    <option value="Cool">Cool</option>
                    <option value="Warm">Warm</option>
                    <option value="Neutral">Neutral</option>
                    <option value="Olive">Olive</option>
                </select>
            </div>
            <div class="filter-group">
                <label>ìƒíƒœ</label>
                <select id="statusFilter">
                    <option value="">ì „ì²´</option>
                    <option value="regular">ì •ê·œ</option>
                    <option value="reserve">ì˜ˆë¹„</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Feedback Status</label>
                <select id="feedbackFilter">
                    <option value="">All</option>
                    <option value="Pending">ğŸ”„ Pending</option>
                    <option value="Ongoing">ğŸ”§ Ongoing</option>
                    <option value="Sent">ğŸ“¤ Sent</option>
                    <option value="Confirmed">âœ… Confirmed</option>
                    <option value="Requested">ğŸ“ Requested</option>
                    <option value="Cancelled">âŒ Cancelled</option>
                    <option value="Duplicate">ğŸ” Duplicate</option>
                </select>
            </div>
            <div class="filter-group" style="flex: 1;">
                <label>ê²€ìƒ‰ (ì´ë¦„)</label>
                <input type="text" placeholder="Elena, Madison..." id="searchInput">
            </div>
            <button class="btn btn-primary" onclick="showCSVData()">ğŸ“„ CSV ë°ì´í„° ë³´ê¸°</button>
            <button class="btn btn-success" onclick="showAddParticipantForm()">â• ìƒˆ ì°¸ê°€ì ì¶”ê°€</button>
            <button class="btn btn-warning" onclick="resetLocalStorage()">ğŸ”„ ë°ì´í„° ì´ˆê¸°í™”</button>
        </div>

        <!-- Table -->
        <div class="participants-table">
            <div class="table-container">
                <table id="participantsTable">
                    <thead>
                        <tr>
                            <th width="40">ID</th>
                            <th width="80">P-ID</th>
                            <th width="80">ë‚ ì§œ</th>
                            <th width="80">ì‹œê°„</th>
                            <th>ì´ë¦„</th>
                            <th width="60">íƒ€ê²Ÿ</th>
                            <th width="80">í†¤</th>
                            <th>ì „í™”ë²ˆí˜¸</th>
                            <th>ì´ë©”ì¼</th>
                            <th width="60">ì˜ˆë¹„ì—¬ë¶€</th>
                            <th width="120">í”¼ë“œë°±ìƒíƒœ</th>
                            <th width="120">ìš”ì²­ì¼ì</th>
                            <th width="120">í™•ì •ì¼ì</th>
                            <th width="100">ì‹œê°„ë³€ê²½</th>
                            <th width="180">ë¹„ê³ </th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="15" class="loading-indicator">ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div style="margin-top: 20px; padding: 10px; background: white; border-radius: 8px; text-align: center;">
            <span id="statusBar" style="color: #666; font-size: 14px;">ì´ <span id="totalParticipants">150</span>ëª… ì¤‘ <span id="displayCount">0</span>ëª… í‘œì‹œ</span>
        </div>
    </div>

    <!-- ìƒˆ ì°¸ê°€ì ì¶”ê°€ ëª¨ë‹¬ -->
    <div id="addParticipantModal" onclick="closeModalOnBackdrop(event)" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
        <div onclick="event.stopPropagation();" style="background: white; margin: 50px auto; padding: 30px; border-radius: 12px; max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h2 style="margin: 0; color: #333;">â• ìƒˆ ì°¸ê°€ì ì¶”ê°€</h2>
                <button onclick="hideAddParticipantForm()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">Ã—</button>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">ì°¸ê°€ìëª… *</label>
                    <input type="text" id="newName" placeholder="ì°¸ê°€ì ì´ë¦„" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">ë‚ ì§œ *</label>
                    <select id="newDate" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="9/22">9/22 (ì›”)</option>
                        <option value="9/23">9/23 (í™”)</option>
                        <option value="9/24">9/24 (ìˆ˜)</option>
                        <option value="9/25">9/25 (ëª©)</option>
                        <option value="9/26">9/26 (ê¸ˆ)</option>
                    </select>
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">ì‹œê°„ *</label>
                    <select id="newTime" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="13:00">13:00</option>
                        <option value="13:30">13:30</option>
                        <option value="14:00">14:00</option>
                        <option value="14:30">14:30</option>
                        <option value="15:00">15:00</option>
                        <option value="15:30">15:30</option>
                        <option value="16:00">16:00</option>
                        <option value="16:30">16:30</option>
                    </select>
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">íƒ€ê²Ÿ *</label>
                    <select id="newTarget" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="1(F)">1(F)</option>
                        <option value="2(L)">2(L)</option>
                        <option value="3(LM)">3(LM)</option>
                        <option value="4(M)">4(M)</option>
                        <option value="5(MD)">5(MD)</option>
                        <option value="6(D)">6(D)</option>
                        <option value="7(R)">7(R)</option>
                    </select>
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">í†¤</label>
                    <select id="newTone" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="Cool">Cool</option>
                        <option value="Warm">Warm</option>
                        <option value="Neutral">Neutral</option>
                        <option value="Olive">Olive</option>
                    </select>
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">ì „í™”ë²ˆí˜¸</label>
                    <input type="text" id="newPhone" placeholder="ì „í™”ë²ˆí˜¸" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                </div>
                
                <div style="grid-column: 1 / -1;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">ì´ë©”ì¼</label>
                    <input type="email" id="newEmail" placeholder="ì´ë©”ì¼ ì£¼ì†Œ" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">P-ID</label>
                    <input type="text" id="newPID" placeholder="P018, P019..." style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                </div>
                
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="newReserve" style="transform: scale(1.2);">
                    <label for="newReserve" style="font-weight: 600; color: #555;">ì˜ˆë¹„ ì°¸ê°€ì</label>
                </div>
                
                <div style="grid-column: 1 / -1;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">ë¹„ê³ </label>
                    <textarea id="newNotes" placeholder="íŠ¹ì´ì‚¬í•­ì´ë‚˜ ìš”ì²­ì‚¬í•­..." style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; height: 80px; resize: vertical;"></textarea>
                </div>
            </div>
            
            <div style="margin-top: 25px; display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="hideAddParticipantForm()" style="padding: 12px 24px; border: 2px solid #ddd; background: white; border-radius: 8px; cursor: pointer; font-weight: 600;">ì·¨ì†Œ</button>
                <button onclick="addNewParticipant()" style="padding: 12px 24px; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; cursor: pointer; font-weight: 600;">â• ì¶”ê°€í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        // ì¸ì¦ ì²´í¬
        function checkAuth() {
            const session = sessionStorage.getItem('clt_session');
            if (!session) {
                window.location.href = 'login.html';
                return null;
            }

            const sessionData = JSON.parse(session);
            if (sessionData.expires < Date.now()) {
                sessionStorage.removeItem('clt_session');
                window.location.href = 'login.html';
                return null;
            }

            return sessionData;
        }

        // ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜
        function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                sessionStorage.removeItem('clt_session');
                window.location.href = 'login.html';
            }
        }

        // ì„¸ì…˜ ì²´í¬ ë° role ê¸°ë°˜ ë¦¬ë””ë ‰ì…˜ (í˜ì´ì§€ ë¡œë“œì‹œ)
        const currentUser = checkAuth();
        if (!currentUser) {
            // ì¸ì¦ ì‹¤íŒ¨ì‹œ í˜ì´ì§€ ì¤‘ë‹¨
            throw new Error('Authentication required');
        }

        // Role-based redirection
        const userRole = currentUser.role || currentUser.userType;
        if (userRole === 'staff') {
            // Staff ì‚¬ìš©ìëŠ” ëª¨ë°”ì¼ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
            window.location.href = 'mobile-attendance.html';
        } else if (userRole === 'viewer') {
            // Viewer ì‚¬ìš©ìëŠ” ë¦¬í¬íŠ¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
            window.location.href = 'report.html';
        }
        // admin, managerëŠ” í˜„ì¬ í˜ì´ì§€ ìœ ì§€

        // Airtable ì„¤ì • (config.jsì—ì„œ ê°€ì ¸ì˜´)
        const AIRTABLE_API_KEY = typeof AIRTABLE_CONFIG !== 'undefined' ? AIRTABLE_CONFIG.API_KEY : 'YOUR_API_KEY_HERE';
        const AIRTABLE_BASE_ID = typeof AIRTABLE_CONFIG !== 'undefined' ? AIRTABLE_CONFIG.BASE_ID : 'appZcPs57spwdoKQH';
        const AIRTABLE_TABLE_ID = typeof AIRTABLE_CONFIG !== 'undefined' ? AIRTABLE_CONFIG.TABLE_ID : 'tblxMzwX1wWJKIOhY';
        const AIRTABLE_API_URL = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_ID}`;

        // ì „ì—­ ë³€ìˆ˜
        let participantsData = [];
        let airtableRecords = {}; // Record ID ì €ì¥ìš©

        // Airtableì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        async function fetchAirtableData() {
            return ErrorHandler.handle(async () => {
                console.log('Airtable ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹œì‘...');
                console.log('API URL:', AIRTABLE_API_URL);

                let allRecords = [];
                let offset = '';
                // í˜ì´ì§€ë„¤ì´ì…˜ì„ í†µí•´ ëª¨ë“  ë ˆì½”ë“œ ê°€ì ¸ì˜¤ê¸°
                do {
                    const url = offset
                        ? `${AIRTABLE_API_URL}?pageSize=100&offset=${offset}`
                        : `${AIRTABLE_API_URL}?pageSize=100`;

                    const response = await ErrorHandler.fetchWithErrorHandling(url, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        timeout: 30000
                    });

                    console.log('Response status:', response.status);

                    const data = await response.json();
                    console.log(`ë°›ì€ ë ˆì½”ë“œ ìˆ˜: ${data.records.length}`);

                    allRecords = allRecords.concat(data.records);
                    offset = data.offset || '';

                } while (offset);

                console.log(`ì „ì²´ ë°›ì€ ë°ì´í„°: ${allRecords.length}ê°œ`);

                // ì²« ë²ˆì§¸ ë ˆì½”ë“œì˜ í•„ë“œ êµ¬ì¡° í™•ì¸ (ë””ë²„ê¹…ìš©)
                if (allRecords.length > 0) {
                    console.log('ì²« ë²ˆì§¸ ë ˆì½”ë“œ í•„ë“œ ëª©ë¡:', Object.keys(allRecords[0].fields));
                    console.log('ì²« ë²ˆì§¸ ë ˆì½”ë“œ ë°ì´í„°:', allRecords[0].fields);
                }

                if (!allRecords || allRecords.length === 0) {
                    console.log('ë ˆì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤. ìƒ˜í”Œ ë°ì´í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.');
                    // ìƒ˜í”Œ ë°ì´í„° ì‚¬ìš©
                    participantsData = [
                        {ID: 1, setDate: "9/22", setTime: "13:00", name: "í…ŒìŠ¤íŠ¸ ì°¸ê°€ì 1", skinColor: "2(L)", skinTone: "Cool", phone: "010-1234-5678", email: "test1@example.com", ì˜ˆë¹„ì—¬ë¶€: false, PID: "P001", status: "Pending", requestDate: "", confirmedDate: "", desc: ""},
                        {ID: 2, setDate: "9/22", setTime: "13:30", name: "í…ŒìŠ¤íŠ¸ ì°¸ê°€ì 2", skinColor: "3(LM)", skinTone: "Warm", phone: "010-2345-6789", email: "test2@example.com", ì˜ˆë¹„ì—¬ë¶€: false, PID: "P002", status: "Pending", requestDate: "", confirmedDate: "", desc: ""},
                        {ID: 3, setDate: "9/23", setTime: "14:00", name: "í…ŒìŠ¤íŠ¸ ì°¸ê°€ì 3", skinColor: "4(M)", skinTone: "Neutral", phone: "010-3456-7890", email: "test3@example.com", ì˜ˆë¹„ì—¬ë¶€: true, PID: "P003", status: "Pending", requestDate: "", confirmedDate: "", desc: ""}
                    ];
                    document.getElementById('syncStatus').innerHTML = 'âš ï¸ ìƒ˜í”Œ ë°ì´í„°';
                } else {
                    // Airtable ë°ì´í„°ë¥¼ ë‚´ë¶€ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                    participantsData = allRecords.map((record, index) => {
                        console.log('Processing record:', record);
                        const recordID = record.fields.ID || (index + 1);
                        airtableRecords[recordID] = record.id;

                        // ë‚ ì§œ í¬ë§· ë³€í™˜ (2025-09-22 -> 9/22)
                        let formattedDate = record.fields.setDate || '';
                        if (formattedDate && formattedDate.includes('-')) {
                            const dateParts = formattedDate.split('-');
                            if (dateParts.length === 3) {
                                const month = parseInt(dateParts[1]);
                                const day = parseInt(dateParts[2]);
                                formattedDate = `${month}/${day}`;
                            }
                        }

                        // ì‹œê°„ í…ìŠ¤íŠ¸ ì²˜ë¦¬ (single text field)
                        // DBì— "13:00", "13:30", "14:00" í˜•ì‹ìœ¼ë¡œ ì €ì¥ë¨
                        // ê°€ëŠ¥í•œ í•„ë“œëª…ë“¤ í™•ì¸: setTime, time, Time, ì‹œê°„
                        let formattedTime = record.fields.setTime || record.fields.time || record.fields.Time || record.fields['ì‹œê°„'] || '';
                        console.log(`ID ${record.fields.ID}: ì‹œê°„ í•„ë“œ í™•ì¸ - setTime='${record.fields.setTime}', time='${record.fields.time}', Time='${record.fields.Time}', ì‹œê°„='${record.fields['ì‹œê°„']}'`);

                        // í…ìŠ¤íŠ¸ë¡œ ì €ì¥ëœ ì‹œê°„ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš© (ì´ë¯¸ HH:MM í˜•ì‹)
                        // ê³µë°± ì œê±°
                        formattedTime = formattedTime.trim();

                        // ë§Œì•½ ë‹¤ë¥¸ í˜•ì‹ì´ ìˆë‹¤ë©´ ë³€í™˜
                        if (formattedTime && !formattedTime.includes(':')) {
                            // "1300" -> "13:00" í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (í•„ìš”ì‹œ)
                            if (formattedTime.length === 4) {
                                formattedTime = formattedTime.substr(0, 2) + ':' + formattedTime.substr(2, 2);
                            }
                        }

                        // ì‹œê°„ í˜•ì‹ ê²€ì¦ ë° ì •ê·œí™”
                        if (formattedTime && formattedTime.includes(':')) {
                            const timeParts = formattedTime.split(':');
                            if (timeParts.length === 2) {
                                const hour = timeParts[0].padStart(2, '0');
                                const minute = timeParts[1].padStart(2, '0');
                                formattedTime = `${hour}:${minute}`;
                            }
                        }

                        console.log(`ID ${record.fields.ID}: ë³€í™˜ëœ ì‹œê°„ ê°’ = '${formattedTime}'`);

                        return {
                            ID: recordID,
                            setDate: formattedDate,
                            setTime: formattedTime,
                            name: record.fields.name || '',
                            skinColor: record.fields.skinColor || '',
                            skinTone: record.fields.skinTone || '',
                            phone: record.fields.phone || '',
                            email: record.fields.email || '',
                            ì˜ˆë¹„ì—¬ë¶€: record.fields.reserveStatus === true || record.fields.reserveStatus === 'true',
                            PID: record.fields['P-ID'] || record.fields.PID || '',
                            status: record.fields.status || 'Pending',  // ê¸°ë³¸ê°’ì„ ì˜ì–´ë¡œ
                            requestDate: record.fields.requestDate || '',
                            confirmedDate: record.fields.confirmedDate || '',
                            desc: record.fields.desc || ''
                        };
                    });
                    document.getElementById('syncStatus').innerHTML = 'âœ… Airtable ì—°ë™';
                }

                console.log('ì²˜ë¦¬ëœ ë°ì´í„°:', participantsData);
                loadParticipants();
                updateStats();
            }, {
                showNotification: true,
                logError: true,
                fallbackValue: null
            }).catch(error => {
                ErrorHandler.logError(error, { context: 'fetchAirtableData' });

                // CORS ì—ëŸ¬ì¼ ê²½ìš° ì•ˆë‚´
                if (error.message.includes('Failed to fetch') || error.message.includes('CORS')) {
                    ErrorHandler.showNotification('CORS ì—ëŸ¬: ë¡œì»¬ì—ì„œëŠ” ìƒ˜í”Œ ë°ì´í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ë°°í¬ í›„ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤.', 'error');

                    // ìƒ˜í”Œ ë°ì´í„°ë¡œ ëŒ€ì²´
                    participantsData = [
                        {ID: 1, setDate: "9/22", setTime: "13:00", name: "ìƒ˜í”Œ ì°¸ê°€ì 1", skinColor: "2(L)", skinTone: "Cool", phone: "010-1234-5678", email: "sample1@example.com", ì˜ˆë¹„ì—¬ë¶€: false, PID: "P001", status: "ëŒ€ê¸°", requestDate: "", confirmedDate: "", desc: ""},
                        {ID: 2, setDate: "9/22", setTime: "13:30", name: "ìƒ˜í”Œ ì°¸ê°€ì 2", skinColor: "3(LM)", skinTone: "Warm", phone: "010-2345-6789", email: "sample2@example.com", ì˜ˆë¹„ì—¬ë¶€: false, PID: "P002", status: "ëŒ€ê¸°", requestDate: "", confirmedDate: "", desc: ""},
                        {ID: 3, setDate: "9/23", setTime: "14:00", name: "ìƒ˜í”Œ ì°¸ê°€ì 3", skinColor: "4(M)", skinTone: "Neutral", phone: "010-3456-7890", email: "sample3@example.com", ì˜ˆë¹„ì—¬ë¶€: true, PID: "P003", status: "ëŒ€ê¸°", requestDate: "", confirmedDate: "", desc: ""}
                    ];
                    document.getElementById('syncStatus').innerHTML = 'âš ï¸ ìƒ˜í”Œ ë°ì´í„° (CORS)';
                    loadParticipants();
                    updateStats();
                } else {
                    ErrorHandler.showNotification('Airtable ì—°ê²° ì‹¤íŒ¨: ' + error.message, 'error');
                    document.getElementById('syncStatus').innerHTML = 'âŒ ì—°ê²° ì‹¤íŒ¨';
                }
            });
        }

        // Airtable ë ˆì½”ë“œ ì—…ë°ì´íŠ¸
        async function updateAirtableRecord(participantId, fieldName, value) {
            return ErrorHandler.handle(async () => {
                const recordId = airtableRecords[participantId];
                if (!recordId) {
                    ErrorHandler.logError(new Error('Record ID not found'), { participantId, fieldName, value });
                    return false;
                }

                console.log(`Airtable ì—…ë°ì´íŠ¸ ì‹œì‘: Record ID=${recordId}, Field=${fieldName}, Value=${value}`);

                // ë‚ ì§œ í•„ë“œì—ì„œ ë¹ˆ ê°’ ì²˜ë¦¬
                let fieldValue = value;
                if ((fieldName === 'requestDate' || fieldName === 'confirmedDate' || fieldName === 'date') && (value === '' || value === null || value === undefined)) {
                    fieldValue = null;
                }
                const response = await ErrorHandler.fetchWithErrorHandling(`${AIRTABLE_API_URL}/${recordId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fields: {
                            [fieldName]: fieldValue
                        }
                    }),
                    timeout: 30000
                });

                const result = await response.json();
                console.log('Airtable ì—…ë°ì´íŠ¸ ì„±ê³µ:', result);
                return true;
            }, {
                showNotification: true,
                logError: true,
                fallbackValue: false
            });
        }

        // Airtableì— ìƒˆ ë ˆì½”ë“œ ì¶”ê°€
        async function createAirtableRecord(participant) {
            return ErrorHandler.handle(async () => {
                const response = await ErrorHandler.fetchWithErrorHandling(AIRTABLE_API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        records: [{
                            fields: {
                                // IDëŠ” Airtableì—ì„œ ìë™ ìƒì„±ë˜ë¯€ë¡œ ì œì™¸
                                name: SecurityUtils.sanitizeInput(participant.name, 'korean_name'),
                                setDate: SecurityUtils.sanitizeInput(participant.setDate, 'date'),
                                setTime: SecurityUtils.sanitizeInput(participant.setTime, 'time'),
                                skinColor: SecurityUtils.sanitizeInput(participant.skinColor, 'alphanumeric'),
                                skinTone: SecurityUtils.sanitizeInput(participant.skinTone || '', 'alphanumeric'),
                                phone: SecurityUtils.sanitizeInput(participant.phone || '', 'phone'),
                                email: SecurityUtils.sanitizeInput(participant.email || '', 'email'),
                                reserveStatus: participant.ì˜ˆë¹„ì—¬ë¶€ ? true : false,
                                'P-ID': SecurityUtils.sanitizeInput(participant.PID || '', 'id'),
                                status: SecurityUtils.sanitizeInput(participant.status || 'Pending', 'alphanumeric'),
                                requestDate: participant.requestDate || null,
                                confirmedDate: participant.confirmedDate || null,
                                changeTime: participant.changeTime || null,
                                desc: SecurityUtils.sanitizeInput(participant.desc || '', 'text')
                            }
                        }]
                    }),
                    timeout: 30000
                });

                const data = await response.json();
                if (data.records && data.records.length > 0) {
                    const createdRecord = data.records[0];
                    // Airtableì´ ìë™ ìƒì„±í•œ IDë¥¼ ê°€ì ¸ì˜´
                    if (createdRecord.fields.ID) {
                        participant.ID = createdRecord.fields.ID;
                    }
                    // Record ID ì €ì¥
                    airtableRecords[participant.ID] = createdRecord.id;
                }

                return true;
            }, {
                showNotification: true,
                logError: true,
                fallbackValue: false
            });
        }

        // ê¸°ë³¸ í•¨ìˆ˜ë“¤
        function loadParticipants() {
            const tbody = document.getElementById('tableBody');
            const dateFilter = document.getElementById('dateFilter').value;
            const timeFilter = document.getElementById('timeFilter').value;
            const targetFilter = document.getElementById('targetFilter').value;
            const toneFilter = document.getElementById('toneFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const feedbackFilter = document.getElementById('feedbackFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            let filtered = participantsData.filter(p => {
                if (dateFilter && p.setDate !== dateFilter) return false;
                if (timeFilter && p.setTime !== timeFilter) return false;
                if (targetFilter && p.skinColor !== targetFilter) return false;
                if (toneFilter && p.skinTone !== toneFilter) return false;
                if (statusFilter) {
                    if (statusFilter === 'regular' && p.ì˜ˆë¹„ì—¬ë¶€) return false;
                    if (statusFilter === 'reserve' && !p.ì˜ˆë¹„ì—¬ë¶€) return false;
                }
                if (feedbackFilter && p.status !== feedbackFilter) return false;
                if (searchTerm && !p.name.toLowerCase().includes(searchTerm)) return false;
                return true;
            });

            // ë‚ ì§œ, ì‹œê°„, ID ìˆœìœ¼ë¡œ ì •ë ¬
            filtered.sort((a, b) => {
                // ë‚ ì§œë¥¼ ìˆ«ìë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜ (M/D í˜•ì‹)
                const parseDate = (dateStr) => {
                    if (!dateStr) return 99999;
                    const parts = dateStr.split('/');
                    if (parts.length === 2) {
                        const month = parseInt(parts[0]);
                        const day = parseInt(parts[1]);
                        return month * 100 + day; // ì˜ˆ: 9/22 -> 922
                    }
                    return 99999;
                };

                // ì‹œê°„ì„ ìˆ«ìë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜ (HH:MM í˜•ì‹)
                const parseTime = (timeStr) => {
                    if (!timeStr) return 9999;
                    // "13:00" -> 1300, "13:30" -> 1330
                    const timeParts = timeStr.split(':');
                    if (timeParts.length === 2) {
                        const hour = parseInt(timeParts[0]) || 0;
                        const minute = parseInt(timeParts[1]) || 0;
                        return hour * 100 + minute;
                    }
                    return 9999;
                };

                // 1. ë¨¼ì € ë‚ ì§œë¡œ ë¹„êµ
                const dateA = parseDate(a.setDate);
                const dateB = parseDate(b.setDate);

                if (dateA !== dateB) {
                    return dateA - dateB;
                }

                // 2. ë‚ ì§œê°€ ê°™ìœ¼ë©´ ì‹œê°„ìœ¼ë¡œ ë¹„êµ
                const timeA = parseTime(a.setTime);
                const timeB = parseTime(b.setTime);

                if (timeA !== timeB) {
                    return timeA - timeB;
                }

                // 3. ë‚ ì§œì™€ ì‹œê°„ì´ ê°™ìœ¼ë©´ IDë¡œ ë¹„êµ
                return (a.ID || 0) - (b.ID || 0);
            });

            const html = filtered.map(p => `
                <tr class="${p.ì˜ˆë¹„ì—¬ë¶€ ? 'reserve-row' : ''}">
                    <td>${p.ID}</td>
                    <td><span class="pid-badge">${p.PID || 'ëŒ€ê¸°'}</span></td>
                    <td>${p.setDate}</td>
                    <td>${p.setTime}</td>
                    <td>
                        ${p.name}
                        ${p.ì˜ˆë¹„ì—¬ë¶€ ? '<span class="reserve-badge">ì˜ˆë¹„</span>' : ''}
                    </td>
                    <td>${p.skinColor}</td>
                    <td>${p.skinTone ? `<span class="tone-badge tone-${p.skinTone.toLowerCase()}">${p.skinTone}</span>` : '-'}</td>
                    <td>${p.phone?.substring(0, 15) || '-'}</td>
                    <td>${p.email?.substring(0, 25) || '-'}</td>
                    <td>${p.ì˜ˆë¹„ì—¬ë¶€ ? 'ì˜ˆë¹„' : 'ì •ê·œ'}</td>
                    <td>
                        <select onchange="updateFeedbackStatus(${p.ID}, this.value)" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                            <option value="Pending" ${p.status === 'Pending' || p.status === 'ëŒ€ê¸°' ? 'selected' : ''}>ğŸ”„ Pending</option>
                            <option value="Ongoing" ${p.status === 'Ongoing' || p.status === 'ì§„í–‰ì¤‘' ? 'selected' : ''}>ğŸ”§ Ongoing</option>
                            <option value="Sent" ${p.status === 'Sent' || p.status === 'ì „ì†¡' ? 'selected' : ''}>ğŸ“¤ Sent</option>
                            <option value="Confirmed" ${p.status === 'Confirmed' || p.status === 'í™•ì •' ? 'selected' : ''}>âœ… Confirmed</option>
                            <option value="Requested" ${p.status === 'Requested' || p.status === 'ìˆ˜ì •ìš”ì²­' ? 'selected' : ''}>ğŸ“ Requested</option>
                            <option value="Cancelled" ${p.status === 'Cancelled' || p.status === 'ì·¨ì†Œ' ? 'selected' : ''}>âŒ Cancelled</option>
                            <option value="Duplicate" ${p.status === 'Duplicate' ? 'selected' : ''}>ğŸ” Duplicate</option>
                        </select>
                    </td>
                    <td>
                        <input type="date" value="${p.requestDate || ''}" onchange="updateRequestDate(${p.ID}, this.value)" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; width: 110px;">
                    </td>
                    <td>
                        <input type="date" value="${p.confirmedDate || ''}" onchange="updateConfirmDate(${p.ID}, this.value)" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; width: 110px;">
                    </td>
                    <td>
                        <select onchange="updateChangeTime(${p.ID}, this.value)" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; width: 90px;" ${p.status === 'Confirmed' || p.status === 'í™•ì •' ? '' : 'disabled'}>
                            <option value="">-</option>
                            <option value="13:00" ${p.changeTime === '13:00' ? 'selected' : ''}>13:00</option>
                            <option value="13:30" ${p.changeTime === '13:30' ? 'selected' : ''}>13:30</option>
                            <option value="14:00" ${p.changeTime === '14:00' ? 'selected' : ''}>14:00</option>
                            <option value="14:30" ${p.changeTime === '14:30' ? 'selected' : ''}>14:30</option>
                            <option value="15:00" ${p.changeTime === '15:00' ? 'selected' : ''}>15:00</option>
                            <option value="15:30" ${p.changeTime === '15:30' ? 'selected' : ''}>15:30</option>
                            <option value="16:00" ${p.changeTime === '16:00' ? 'selected' : ''}>16:00</option>
                            <option value="16:30" ${p.changeTime === '16:30' ? 'selected' : ''}>16:30</option>
                        </select>
                    </td>
                    <td>
                        <input type="text" value="${p.desc || ''}" onchange="updateNotes(${p.ID}, this.value)" placeholder="ë¹„ê³ ..." style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; width: 160px;">
                    </td>
                </tr>
            `).join('');

            tbody.innerHTML = html || '<tr><td colspan="15" style="text-align: center; padding: 40px;">í•„í„° ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';

            document.getElementById('displayCount').textContent = filtered.length;
            document.getElementById('totalParticipants').textContent = participantsData.length;

            // í•„í„° ë³€ê²½ì‹œ í†µê³„ ì—…ë°ì´íŠ¸
            updateStats();
        }

        function updateStats() {
            // í˜„ì¬ í•„í„°ëœ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const dateFilter = document.getElementById('dateFilter').value;
            const timeFilter = document.getElementById('timeFilter').value;
            const targetFilter = document.getElementById('targetFilter').value;
            const toneFilter = document.getElementById('toneFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const feedbackFilter = document.getElementById('feedbackFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            // í•„í„° ì ìš©
            let filtered = participantsData.filter(p => {
                if (dateFilter && p.setDate !== dateFilter) return false;
                if (timeFilter && p.setTime !== timeFilter) return false;
                if (targetFilter && p.skinColor !== targetFilter) return false;
                if (toneFilter && p.skinTone !== toneFilter) return false;
                if (statusFilter) {
                    if (statusFilter === 'regular' && p.ì˜ˆë¹„ì—¬ë¶€) return false;
                    if (statusFilter === 'reserve' && !p.ì˜ˆë¹„ì—¬ë¶€) return false;
                }
                if (feedbackFilter && p.status !== feedbackFilter) return false;
                if (searchTerm && !p.name.toLowerCase().includes(searchTerm)) return false;
                return true;
            });

            // Duplicate ìƒíƒœë¥¼ ì œì™¸í•œ ë°ì´í„°ë§Œ ì§‘ê³„ ëŒ€ìƒ
            const nonDuplicateFiltered = filtered.filter(p => p.status !== 'Duplicate');

            // ê¸°ë³¸ í†µê³„ (Duplicate ì œì™¸)
            const total = nonDuplicateFiltered.length;
            const regular = nonDuplicateFiltered.filter(p => !p.ì˜ˆë¹„ì—¬ë¶€).length;
            const reserve = nonDuplicateFiltered.filter(p => p.ì˜ˆë¹„ì—¬ë¶€).length;
            const matched = nonDuplicateFiltered.filter(p => p.PID && p.PID !== '').length;
            const matchRate = total > 0 ? Math.round((matched / total) * 100) : 0;

            const requestCount = nonDuplicateFiltered.filter(p => p.requestDate && p.requestDate.trim() !== '').length;
            const confirmCount = nonDuplicateFiltered.filter(p => p.confirmedDate && p.confirmedDate.trim() !== '').length;

            // í”¼ë“œë°± ìƒíƒœë³„ ì§‘ê³„ (í•„í„°ëœ ë°ì´í„° ê¸°ì¤€)
            const pendingCount = filtered.filter(p => p.status === 'Pending' || p.status === 'ëŒ€ê¸°').length;
            const ongoingCount = filtered.filter(p => p.status === 'Ongoing' || p.status === 'ì§„í–‰ì¤‘').length;
            const sentCount = filtered.filter(p => p.status === 'Sent' || p.status === 'ì „ì†¡').length;
            const confirmedStatusCount = filtered.filter(p => p.status === 'Confirmed' || p.status === 'í™•ì •').length;
            const requestedCount = filtered.filter(p => p.status === 'Requested' || p.status === 'ìˆ˜ì •ìš”ì²­').length;
            const cancelledCount = filtered.filter(p => p.status === 'Cancelled' || p.status === 'ì·¨ì†Œ').length;
            const duplicateCount = filtered.filter(p => p.status === 'Duplicate').length;

            // ê¸°ë³¸ í†µê³„ ì—…ë°ì´íŠ¸
            document.getElementById('totalCount').textContent = total;
            document.getElementById('totalDetail').textContent = `ì •ê·œ: ${regular} | ì˜ˆë¹„: ${reserve}`;
            document.getElementById('matchedCount').textContent = matched;
            document.getElementById('matchRate').textContent = `${matchRate}%`;
            document.getElementById('requestConfirmCount').textContent = `${requestCount}/${confirmCount}`;
            document.getElementById('requestConfirmDetail').textContent = `ìš”ì²­: ${requestCount}ê±´ | í™•ì •: ${confirmCount}ê±´`;

            // ì„ íƒëœ ë‚ ì§œ í‘œì‹œ
            if (dateFilter) {
                document.getElementById('selectedDateDisplay').textContent = `- ${dateFilter}`;
            } else {
                document.getElementById('selectedDateDisplay').textContent = '- ì „ì²´';
            }

            // ë‚ ì§œë³„ ë¶„í¬ ì—…ë°ì´íŠ¸ (í•„í„° ì ìš©ì‹œ)
            if (dateFilter) {
                document.getElementById('dateDistribution').textContent = dateFilter;
                document.getElementById('dateDistributionDetail').textContent = `${total}ëª…`;
            } else {
                // ì „ì²´ ë‚ ì§œ ë¶„í¬ ê³„ì‚° (Duplicate ì œì™¸)
                const dateCounts = {};
                nonDuplicateFiltered.forEach(p => {
                    if (p.setDate) {
                        dateCounts[p.setDate] = (dateCounts[p.setDate] || 0) + 1;
                    }
                });
                const uniqueDates = Object.keys(dateCounts).length;
                document.getElementById('dateDistribution').textContent = `${uniqueDates}ì¼`;
                const dateDetail = Object.entries(dateCounts)
                    .sort((a, b) => a[0].localeCompare(b[0]))
                    .map(([date, count]) => `${date}: ${count}ëª…`)
                    .join(' | ');
                document.getElementById('dateDistributionDetail').textContent = dateDetail || 'ë‚ ì§œë³„ ë¶„í¬';
            }

            // í”¼ë“œë°± ìƒíƒœ í†µê³„ ì—…ë°ì´íŠ¸
            document.getElementById('pendingCount').textContent = pendingCount;
            document.getElementById('pendingPercent').textContent = total > 0 ? `${Math.round((pendingCount / total) * 100)}%` : '0%';

            document.getElementById('ongoingCount').textContent = ongoingCount;
            document.getElementById('ongoingPercent').textContent = total > 0 ? `${Math.round((ongoingCount / total) * 100)}%` : '0%';

            document.getElementById('sentCount').textContent = sentCount;
            document.getElementById('sentPercent').textContent = total > 0 ? `${Math.round((sentCount / total) * 100)}%` : '0%';

            document.getElementById('confirmedCount').textContent = confirmedStatusCount;
            document.getElementById('confirmedPercent').textContent = total > 0 ? `${Math.round((confirmedStatusCount / total) * 100)}%` : '0%';

            document.getElementById('requestedCount').textContent = requestedCount;
            document.getElementById('requestedPercent').textContent = total > 0 ? `${Math.round((requestedCount / total) * 100)}%` : '0%';

            document.getElementById('cancelledCount').textContent = cancelledCount;
            document.getElementById('cancelledPercent').textContent = total > 0 ? `${Math.round((cancelledCount / total) * 100)}%` : '0%';

            document.getElementById('duplicateCount').textContent = duplicateCount;
            document.getElementById('duplicatePercent').textContent = total > 0 ? `${Math.round((duplicateCount / total) * 100)}%` : '0%';
        }

        async function updateFeedbackStatus(participantId, newStatus) {
            return ErrorHandler.handle(async () => {
                const participant = participantsData.find(p => p.ID === participantId);
                if (!participant) {
                    throw new Error('ì°¸ê°€ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }

                console.log(`í”¼ë“œë°± ìƒíƒœ ë³€ê²½: ID ${participantId}, ${participant.status} -> ${newStatus}`);
                participant.status = newStatus;

                // Airtable ì—…ë°ì´íŠ¸ - ì˜ì–´ ê°’ ì „ì†¡
                const success = await updateAirtableRecord(participantId, 'status', newStatus);
                if (success) {
                    ErrorHandler.showNotification(`${participant.name}ì˜ í”¼ë“œë°± ìƒíƒœê°€ '${newStatus}'ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                    console.log(`Airtable ì—…ë°ì´íŠ¸ ì„±ê³µ: ID ${participantId}`);
                } else {
                    ErrorHandler.showNotification(`${participant.name}ì˜ í”¼ë“œë°± ìƒíƒœ ì €ì¥ ì‹¤íŒ¨\n(Airtableì˜ status í•„ë“œì— ${newStatus} ì˜µì…˜ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”)`, 'error');
                    // ë¡œì»¬ ìƒíƒœëŠ” ìœ ì§€
                }
                updateStats();
            }, {
                showNotification: true,
                logError: true
            });
        }

        async function updateRequestDate(participantId, newDate) {
            return ErrorHandler.handle(async () => {
                const participant = participantsData.find(p => p.ID === participantId);
                if (!participant) {
                    throw new Error('ì°¸ê°€ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }

                participant.requestDate = newDate;

                // Airtable ì—…ë°ì´íŠ¸ - ë¹ˆ ë¬¸ìì—´ ëŒ€ì‹  null ì „ì†¡
                const valueToSend = (newDate === '' || newDate === null) ? null : newDate;
                const success = await updateAirtableRecord(participantId, 'requestDate', valueToSend);

                if (newDate && newDate.trim() !== '') {
                    participant.status = 'Requested';
                    await updateAirtableRecord(participantId, 'status', 'Requested');
                    loadParticipants(); // í™”ë©´ ìƒˆë¡œê³ ì¹¨
                }

                if (success) {
                    ErrorHandler.showNotification(`${participant.name}ì˜ ìš”ì²­ì¼ìê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                }
                updateStats();
            }, {
                showNotification: true,
                logError: true
            });
        }

        async function updateConfirmDate(participantId, newDate) {
            return ErrorHandler.handle(async () => {
                const participant = participantsData.find(p => p.ID === participantId);
                if (!participant) {
                    throw new Error('ì°¸ê°€ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }

                participant.confirmedDate = newDate;

                // Airtable ì—…ë°ì´íŠ¸ - ë¹ˆ ë¬¸ìì—´ ëŒ€ì‹  null ì „ì†¡
                const valueToSend = (newDate === '' || newDate === null) ? null : newDate;
                const success = await updateAirtableRecord(participantId, 'confirmedDate', valueToSend);

                if (newDate && newDate.trim() !== '') {
                    participant.status = 'Confirmed';
                    await updateAirtableRecord(participantId, 'status', 'Confirmed');
                    loadParticipants(); // í™”ë©´ ìƒˆë¡œê³ ì¹¨
                }

                if (success) {
                    ErrorHandler.showNotification(`${participant.name}ì˜ í™•ì •ì¼ìê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                }
                updateStats();
            }, {
                showNotification: true,
                logError: true
            });
        }

        async function updateChangeTime(participantId, newTime) {
            return ErrorHandler.handle(async () => {
                const participant = participantsData.find(p => p.ID === participantId);
                if (!participant) {
                    throw new Error('ì°¸ê°€ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }

                participant.changeTime = newTime;

                // Airtableì— changeTime ì—…ë°ì´íŠ¸
                const success = await updateAirtableRecord(participantId, 'changeTime', newTime);

                // 3ê°€ì§€ ì¡°ê±´ í™•ì¸: Confirmed ìƒíƒœ, í™•ì •ì¼ì ìˆìŒ, ì‹œê°„ë³€ê²½ ì„ íƒë¨
                if ((participant.status === 'Confirmed' || participant.status === 'í™•ì •') &&
                    participant.confirmedDate &&
                    participant.confirmedDate.trim() !== '' &&
                    newTime && newTime !== '') {

                    // setDateë¥¼ confirmedDateë¡œ ë³€ê²½
                    const oldDate = participant.setDate;
                    const oldTime = participant.setTime;

                    let newDate = participant.confirmedDate;
                    participant.setDate = newDate;
                    participant.setTime = newTime;

                    // Airtableì— ì—…ë°ì´íŠ¸
                    await updateAirtableRecord(participantId, 'setDate', newDate);
                    await updateAirtableRecord(participantId, 'setTime', newTime);

                    ErrorHandler.showNotification(
                        `${participant.name}ì˜ ì˜ˆì•½ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.\n` +
                        `${oldDate} ${oldTime} â†’ ${newDate} ${newTime}`,
                        'success'
                    );

                    // í…Œì´ë¸” ìƒˆë¡œê³ ì¹¨
                    loadParticipants();
                } else if (success) {
                    ErrorHandler.showNotification(`${participant.name}ì˜ ì‹œê°„ë³€ê²½ ì˜µì…˜ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                }
            }, {
                showNotification: true,
                logError: true
            });
        }

        async function updateNotes(participantId, newNotes) {
            return ErrorHandler.handle(async () => {
                const participant = participantsData.find(p => p.ID === participantId);
                if (!participant) {
                    throw new Error('ì°¸ê°€ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }

                // Sanitize input
                const sanitizedNotes = SecurityUtils.sanitizeInput(newNotes, 'text');
                participant.desc = sanitizedNotes;

                // Airtable ì—…ë°ì´íŠ¸
                await updateAirtableRecord(participantId, 'desc', sanitizedNotes);
            }, {
                showNotification: false,
                logError: true
            });
        }

        function showNotification(message, type = 'success') {
            ErrorHandler.showNotification(message, type);
        }

        function showCSVData() {
            const headers = ['ID', 'name', 'setDate', 'setTime', 'skinColor', 'skinTone', 'phone', 'email', 'reserveStatus', 'P-ID', 'status', 'requestDate', 'confirmedDate', 'desc'];
            
            let csvContent = headers.join(',') + '\n';
            
            participantsData.forEach(p => {
                const row = [
                    p.ID || '',
                    `"${p.name || ''}"`,
                    p.setDate || '',
                    p.setTime || '',
                    p.skinColor || '',
                    p.skinTone || '',
                    p.phone || '',
                    p.email || '',
                    p.ì˜ˆë¹„ì—¬ë¶€ ? 'TRUE' : 'FALSE',
                    p.PID || '',
                    p.status || 'ëŒ€ê¸°',
                    p.requestDate || '',
                    p.confirmedDate || '',
                    `"${p.desc || ''}"`
                ];
                csvContent += row.join(',') + '\n';
            });
            
            const modal = document.createElement('div');
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;';
            
            const content = document.createElement('div');
            content.onclick = (e) => e.stopPropagation();
            content.style.cssText = 'background: white; margin: 50px auto; padding: 30px; border-radius: 12px; max-width: 90%; max-height: 80vh; overflow-y: auto;';
            
            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">ğŸ“„ CSV ë°ì´í„° (${participantsData.length}ëª…)</h2>
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">Ã—</button>
                </div>
                <textarea readonly style="width: 100%; height: 400px; font-family: monospace; font-size: 12px; border: 2px solid #e0e0e0; border-radius: 8px; padding: 10px;">${csvContent}</textarea>
                <div style="margin-top: 15px; text-align: right;">
                    <button onclick="navigator.clipboard.writeText(this.parentElement.previousElementSibling.value).then(() => { alert('âœ… CSV ë°ì´í„°ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!'); })" style="padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">ğŸ“‹ í´ë¦½ë³´ë“œ ë³µì‚¬</button>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }

        function showAddParticipantForm() {
            document.getElementById('addParticipantModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function hideAddParticipantForm() {
            document.getElementById('addParticipantModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            
            // í¼ ì´ˆê¸°í™”
            document.getElementById('newName').value = '';
            document.getElementById('newDate').value = '';
            document.getElementById('newTime').value = '';
            document.getElementById('newTarget').value = '';
            document.getElementById('newTone').value = '';
            document.getElementById('newPhone').value = '';
            document.getElementById('newEmail').value = '';
            document.getElementById('newPID').value = '';
            document.getElementById('newReserve').checked = false;
            document.getElementById('newNotes').value = '';
        }

        function closeModalOnBackdrop(event) {
            if (event.target === event.currentTarget) {
                hideAddParticipantForm();
            }
        }

        async function addNewParticipant() {
            return ErrorHandler.handle(async () => {
                const formData = {
                    name: document.getElementById('newName').value,
                    setDate: document.getElementById('newDate').value,
                    setTime: document.getElementById('newTime').value,
                    skinColor: document.getElementById('newTarget').value,
                    skinTone: document.getElementById('newTone').value,
                    phone: document.getElementById('newPhone').value,
                    email: document.getElementById('newEmail').value,
                    PID: document.getElementById('newPID').value,
                    desc: document.getElementById('newNotes').value
                };

                // Validate form data
                const schema = {
                    name: { required: true, type: 'korean_name', minLength: 2, maxLength: 50, label: 'ì°¸ê°€ìëª…' },
                    setDate: { required: true, type: 'date', label: 'ë‚ ì§œ' },
                    setTime: { required: true, type: 'time', label: 'ì‹œê°„' },
                    skinColor: { required: true, type: 'alphanumeric', label: 'íƒ€ê²Ÿ' },
                    skinTone: { required: false, type: 'alphanumeric' },
                    phone: { required: false, type: 'phone' },
                    email: { required: false, type: 'email' },
                    PID: { required: false, type: 'id' },
                    desc: { required: false, type: 'text', maxLength: 500 }
                };

                const validation = SecurityUtils.validateFormData(formData, schema);
                if (!validation.isValid) {
                    const errorMessages = Object.values(validation.errors).join('\n');
                    ErrorHandler.showNotification('ì…ë ¥ ì˜¤ë¥˜:\n' + errorMessages, 'error');
                    return;
                }

                const maxId = Math.max(...participantsData.map(p => p.ID), 0);
                const newId = maxId + 1;

                const newParticipant = {
                    ID: newId,
                    setDate: validation.data.setDate,
                    setTime: validation.data.setTime,
                    name: validation.data.name,
                    skinColor: validation.data.skinColor,
                    skinTone: validation.data.skinTone || '',
                    phone: validation.data.phone || '',
                    email: validation.data.email || '',
                    ì˜ˆë¹„ì—¬ë¶€: document.getElementById('newReserve').checked,
                    PID: validation.data.PID || '',
                    status: 'Pending',  // ì˜ì–´ ê¸°ë³¸ê°’
                    requestDate: '',
                    confirmedDate: '',
                    changeTime: '',  // ì‹œê°„ë³€ê²½ í•„ë“œ ì¶”ê°€
                    desc: validation.data.desc || ''
                };

                // Airtableì— ì¶”ê°€
                const success = await createAirtableRecord(newParticipant);

                if (success) {
                    participantsData.push(newParticipant);
                    loadParticipants();
                    updateStats();
                    hideAddParticipantForm();
                    ErrorHandler.showNotification(`ìƒˆ ì°¸ê°€ì '${validation.data.name}'ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤! (ID: ${newId})`, 'success');
                }
            }, {
                showNotification: true,
                logError: true
            });
        }

        async function resetLocalStorage() {
            if (confirm('âš ï¸ Airtableì—ì„œ ìµœì‹  ë°ì´í„°ë¥¼ ë‹¤ì‹œ ê°€ì ¸ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return ErrorHandler.handle(async () => {
                    await fetchAirtableData();
                    ErrorHandler.showNotification('âœ… Airtableì—ì„œ ë°ì´í„°ë¥¼ ìƒˆë¡œê³ ì¹¨í–ˆìŠµë‹ˆë‹¤.', 'success');
                }, {
                    showNotification: true,
                    logError: true
                });
            }
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupEventListeners() {
            document.getElementById('dateFilter').addEventListener('change', loadParticipants);
            document.getElementById('timeFilter').addEventListener('change', loadParticipants);
            document.getElementById('targetFilter').addEventListener('change', loadParticipants);
            document.getElementById('toneFilter').addEventListener('change', loadParticipants);
            document.getElementById('statusFilter').addEventListener('change', loadParticipants);
            document.getElementById('feedbackFilter').addEventListener('change', loadParticipants);
            document.getElementById('searchInput').addEventListener('input', loadParticipants);
        }

        // í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async function() {
            return ErrorHandler.handle(async () => {
                // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
                if (currentUser) {
                    document.getElementById('userInfo').textContent = `ğŸ‘¤ ${SecurityUtils.sanitizeHTML(currentUser.fullName)} (${SecurityUtils.sanitizeHTML(currentUser.role)})`;
                }

                document.getElementById('tableBody').innerHTML = '<tr><td colspan="15" class="loading-indicator">Airtableì—ì„œ ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘...</td></tr>';
                await fetchAirtableData();
                setupEventListeners();
            }, {
                showNotification: true,
                logError: true
            });
        });
    </script>
</body>
</html>